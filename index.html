<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SportingLabs W3Labs</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@600;700&family=Teko:wght@500;700&family=Roboto+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link id="flatpickr-theme" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <!-- Markdown Parser -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* DARK MODE (DEFAULT) VARIABLES */
            --bg-deep: #050507;
            --bg-overlay-opacity: 0.6;
            --bg-overlay-color: #000;
            
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --text-primary: #ffffff;
            --text-muted: #9ca3af;
            --text-invert: #000000;
            
            --header-bg: rgba(5, 5, 7, 0.9);
            --nav-item-bg: rgba(255, 255, 255, 0.05);
            --nav-item-hover: rgba(255, 255, 255, 0.1);
            
            --card-bg-gradient: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            
            --input-bg: rgba(0,0,0,0.4);
            --input-border: var(--glass-border);
            --modal-bg: #0f0f11;
            --table-header-bg: rgba(255,255,255,0.02);
            --dropdown-bg: #111;
            
            /* Persona Base (Adulto) */
            --font-family-primary: 'Nokia Pure Headline', sans-serif;
            --font-family-secondary: 'Roboto Condensed', sans-serif;
            --base-font-size: 1rem;
            --heading-font-size: 1.5rem;
            --card-border-radius: 24px;
            --spacing-unit: 16px;
            --button-padding-y: 8px;
            --button-padding-x: 16px;
            --nav-item-padding: 14px 18px;
            --nav-item-border-radius: 16px;

            /* Cores Fixas */
            --accent: #d1ff4d;
            --ai-color: #a855f7;
            --ai-glow: rgba(168, 85, 247, 0.4);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);

            --scrollbar-thumb-bg: rgba(128,128,128,0.3);
            /* Zonas da Tabela */
            --zone-libertadores: #4285f4;
            --zone-prelibertadores: #00bfff;
            --zone-sulamericana: #fbbc05;
            --zone-rebaixamento: #ea4335;
            --zone-acesso: #34a853;
            --zone-neutra: rgba(128,128,128,0.2);
        }

        /* LIGHT MODE VARIABLES */
        body.light-mode {
            --bg-deep: #f3f4f6;
            --bg-overlay-opacity: 0.85;
            --bg-overlay-color: #fff;
            
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(0, 0, 0, 0.05);
            
            --text-primary: #111827;
            --text-muted: #6b7280;
            --text-invert: #ffffff;
            
            --header-bg: rgba(255, 255, 255, 0.9);
            --nav-item-bg: rgba(0, 0, 0, 0.05);
            --nav-item-hover: rgba(0, 0, 0, 0.1);
            
            --card-bg-gradient: #ffffff;
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
            
            --input-bg: rgba(255, 255, 255, 0.8);
            --input-border: rgba(0,0,0,0.1);

            --modal-bg: #ffffff;
            --table-header-bg: rgba(0,0,0,0.03);
            --dropdown-bg: #fff;
            --scrollbar-thumb-bg: rgba(0,0,0,0.2);
        }

        /* === PERSONA: JOVEM DINÂMICO === */
        body.persona-young {
            --bg-deep: #0a0a1a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-primary: #e0f7fa;
            --text-muted: #80deea;
            --accent: #00e676; /* Verde neon */
            --ai-color: #00e676;
            --ai-glow: rgba(0, 230, 118, 0.4);
            --header-bg: rgba(10, 10, 26, 0.9);
            --nav-item-bg: rgba(0, 230, 118, 0.1);
            --nav-item-hover: rgba(0, 230, 118, 0.2);
            --card-shadow: 0 10px 40px 0 rgba(0, 230, 118, 0.2);
            --dropdown-bg: #0a0a1a;

            --font-family-primary: 'Chakra Petch', sans-serif;
            --font-family-secondary: 'Teko', sans-serif;
            --base-font-size: 0.95rem;
            --heading-font-size: 1.8rem;
            --card-border-radius: 16px;
            --spacing-unit: 12px;
            --button-padding-y: 10px;
            --button-padding-x: 20px;
            --nav-item-padding: 12px 16px;
            --nav-item-border-radius: 12px;
        }

        /* === PERSONA: PÚBLICO IDOSO === */
        body.persona-elderly {
            --bg-deep: #f0f0f0;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.1);
            --text-primary: #333333;
            --text-muted: #666666;
            --text-invert: #ffffff;
            --accent: #007bff; /* Azul clássico */
            --ai-color: #007bff;
            --ai-glow: rgba(0, 123, 255, 0.4);
            --header-bg: rgba(255, 255, 255, 0.95);
            --nav-item-bg: rgba(0, 0, 0, 0.05);
            --nav-item-hover: rgba(0, 0, 0, 0.1);
            --card-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            --dropdown-bg: #ffffff;

            --font-family-primary: 'Roboto Condensed', sans-serif;
            --font-family-secondary: 'Roboto Condensed', sans-serif;
            --base-font-size: 1.1rem;
            --heading-font-size: 1.6rem;
            --card-border-radius: 8px;
            --spacing-unit: 20px;
            --button-padding-y: 12px;
            --button-padding-x: 24px;
            --nav-item-padding: 16px 20px;
            --nav-item-border-radius: 8px;
        }

        /* === FONTES LOCAIS (NOKIA PURE) === */
        @font-face {
            font-family: 'Nokia Pure Headline';
            src: url('./fonts/nokiapureheadline_ultralight.woff2') format('woff2'),
                 url('./fonts/nokiapureheadline_ultralight.woff') format('woff'),
                 url('./fonts/nokiapureheadline_ultralight.otf') format('opentype');
            font-weight: 200;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Nokia Pure Headline';
            src: url('./fonts/nokiapureheadline_light.woff2') format('woff2'),
                 url('./fonts/nokiapureheadline_light.woff') format('woff'),
                 url('./fonts/nokiapureheadline_light.otf') format('opentype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Nokia Pure Headline';
            src: url('./fonts/nokiapureheadline_regular.woff2') format('woff2'),
                 url('./fonts/nokiapureheadline_regular.woff') format('woff'),
                 url('./fonts/nokiapureheadline_regular.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Nokia Pure Headline';
            src: url('./fonts/nokiapureheadline_bold.woff2') format('woff2'),
                 url('./fonts/nokiapureheadline_bold.woff') format('woff'),
                 url('./fonts/nokiapureheadline_bold.otf') format('opentype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        /* === GLOBAL STYLES === */
        body {
            font-family: var(--font-family-primary);
            background-color: var(--bg-deep);
            color: var(--text-primary);
            margin: 0; padding: 0; 
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        #app-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10;
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(16px);
            transform: scale(1.1);
            transition: background-image 0.8s ease-in-out;
        }
        #app-background::after {
            content: ''; position: absolute; inset: 0;
            background-color: var(--bg-overlay-color);
            opacity: var(--bg-overlay-opacity);
            transition: background-color 0.3s, opacity 0.3s;
        }

        ::-webkit-scrollbar { width: 6px; background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 3px; }

        /* Loader */
        #global-loader { 
            position: fixed; inset: 0; background: var(--bg-deep); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.5s;
        }
        .loader-ring {
            width: 60px; height: 60px; border-radius: 50%;
            border: 2px solid transparent; border-top-color: var(--accent);
            animation: spin 0.8s linear infinite;
        }
        .loader-hidden { opacity: 0; pointer-events: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* UI Components */
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            box-shadow: var(--card-shadow);
        }

        .header-main {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50; height: 70px;
            background: var(--header-bg); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            transition: background 0.3s;
        }

        .logo-text { 
            font-weight: 800; font-size: 1.5rem; letter-spacing: -0.05em; 
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-muted) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logo-text span { 
            color: var(--accent); -webkit-text-fill-color: var(--accent);
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        .nav-pill {
            background: var(--nav-item-bg); border: 1px solid var(--glass-border); /* Usar var(--nav-item-border-radius) para consistência */
            color: var(--text-primary); padding: var(--button-padding-y) var(--button-padding-x); border-radius: 100px;
            font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px;
            transition: all 0.3s var(--ease-smooth), border-color 0.3s;
            white-space: nowrap;
        }
        .nav-pill:hover, .nav-pill.active {
            background: var(--nav-item-hover); border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            color: var(--text-primary);
        }
        .dropdown-menu {
            background-color: var(--dropdown-bg);
        }
        body.light-mode .nav-pill:hover, body.light-mode .nav-pill.active { box-shadow: 0 0 5px var(--accent); }

        .search-input {
            width: 100%; background: var(--input-bg); 
            border: 1px solid var(--input-border);
            padding: var(--button-padding-y) var(--button-padding-x) var(--button-padding-y) calc(var(--button-padding-x) * 2.5); border-radius: var(--nav-item-border-radius); color: var(--text-primary); font-family: var(--font-family-primary);
            transition: all 0.3s, border-color 0.3s;
        }
        .search-input:focus {
            border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(128, 128, 128, 0.1);
        }

        .theme-toggle-btn {
            width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
            background: var(--nav-item-bg); border: 1px solid var(--glass-border);
            color: var(--text-primary); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
            border-radius: 50%; /* Mantém redondo */
        }
        .theme-toggle-btn:hover { background: var(--nav-item-hover); color: var(--accent); }
        
        /* === UNIFIED TV SCOREBOARD === */
        .match-card {
            background: var(--card-bg-gradient);
            border: 1px solid var(--glass-border); border-radius: var(--card-border-radius); overflow: hidden; position: relative; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
            margin-bottom: 16px; animation: fade-slide-up 0.6s var(--ease-smooth) forwards; opacity: 0;
            box-shadow: var(--card-shadow);
            padding: 12px;
        }
        .match-card:hover { transform: translateY(-4px) scale(1.01); border-color: var(--accent); z-index: 10; }
        @keyframes fade-slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .unified-broadcast-board {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .unified-main-bar {
            display: flex;
            align-items: stretch;
            height: 50px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--input-bg);
            position: relative;
            justify-content: space-between;
        }

        /* NOVO: Pseudo-elemento para criar o efeito de blur em todo o placar */
        .unified-main-bar::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 8px; /* Garante que o blur não vaze das bordas arredondadas */
            background: rgba(255, 255, 255, 0.05); /* Leve brilho para o efeito de vidro */
            backdrop-filter: blur(5px); /* Usar var(--blur-intensity) */
            -webkit-backdrop-filter: blur(5px);
            z-index: 5; /* Fica acima das cores de fundo, mas abaixo do texto e logos */
        }

        .unified-team-block {
            display: flex;
            align-items: center;
            padding: 0 16px;
            min-width: 100px;
            position: relative;
            height: 100%;
            transition: background-color 0.3s;
            /* O background-color será definido dinamicamente via JavaScript com a cor do time */
        }
        .unified-team-block::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(0,0,0,0.2));
            z-index: 0;
        }
        /* Removido body.light-mode .unified-team-block pois o background é dinâmico */

        .unified-team-block.left { 
            justify-content: flex-start;
            margin-right: -2px;
        }

        .unified-team-block.right { 
            justify-content: flex-end; 
            margin-left: -2px;
        }

        .unified-team-abbr {
            color: var(--text-primary);
            font-weight: 900;
            font-size: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            letter-spacing: 0.5px;
            z-index: 6;
            position: relative;
            font-family: 'Nokia Pure Headline', sans-serif;
        }

        .unified-center-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            /* O background será definido dinamicamente via JavaScript */
        }

        .unified-score-num {
            width: 35px;
            text-align: center;
            color: #000000;
            color: var(--text-primary); /* Adapta a cor do texto ao tema */
            font-weight: 900;
            font-size: 2.2rem;
            line-height: 1;
            z-index: 6;
            position: relative;
            font-family: 'Nokia Pure Headline', sans-serif;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5), 0 -1px 0 rgba(0,0,0,0.3);
        }

        .unified-league-logo-area {
            margin: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 6;
        }

        .unified-league-logo-area img {
            max-height: 35px;
            max-width: 35px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .unified-team-logo {
            height: 32px;
            width: 32px;
            object-fit: contain;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
            z-index: 6;
            position: relative;
        }

        .unified-timer-pill {
            margin-top: -4px;
            background: linear-gradient(to bottom, color-mix(in srgb, var(--accent) 90%, white), color-mix(in srgb, var(--accent) 90%, black));
            color: #000000; /* Texto preto para o cronômetro */
            padding: 2px 10px 4px 10px;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            font-weight: 900;
            font-size: 1.1rem;
            text-align: center;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3), inset 0 1px 0 color-mix(in srgb, var(--accent) 80%, white);
            border: 1px solid rgba(0,0,0,0.2);
            border-top: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-family: 'Nokia Pure Headline', sans-serif;
            text-shadow: 0 1px 0 rgba(255,255,255,0.2);
        }

        /* --- OVERLAYS GERAIS (Cartão e Gol) --- */
        .unified-full-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 25;
            transform: translateY(100%); /* Começa escondido embaixo */
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-radius: 8px; /* Match parent */
        }

        .unified-full-overlay.active {
            transform: translateY(0);
        }

        /* Cores de Fundo Overlays */
        .bg-yellow-overlay { background-color: #FFD700; color: black; }
        .bg-red-overlay { background-color: #DC2626; color: white; }

        /* Gradiente para GOL */
        .bg-goal-generic {
            background: linear-gradient(90deg, var(--accent) 0%, color-mix(in srgb, var(--accent) 70%, black) 100%);
            color: var(--text-invert);
        }

        /* Elementos Visuais dos Overlays */
        .unified-overlay-logo {
            height: 40px;
            width: 40px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            margin-right: 10px;
        }

        /* --- ESTILOS DO CARTÃO (Para futura implementação) --- */
        .unified-card-info-group { display: flex; align-items: center; gap: 12px; flex: 1; justify-content: flex-end; }
        .unified-card-text-group { display: flex; flex-direction: column; align-items: flex-end; line-height: 1; }
        .unified-card-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; opacity: 0.8; margin-bottom: 2px; }
        .unified-card-player-name { font-size: 1.2rem; font-weight: 900; text-transform: uppercase; font-family: 'Roboto Condensed', sans-serif; }
        .unified-card-player-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.4);
            background-color: var(--glass-border);
        }

        /* --- ESTILOS DA SUBSTITUIÇÃO --- */
        .bg-sub-overlay { background-color: #1E40AF; color: white; } /* Tailwind blue-800 */
        .sub-info-group {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex: 1;
            gap: 10px;
            padding: 0 10px;
        }
        .sub-player-group {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
        }
        .sub-player-group .unified-card-player-name {
            font-size: 1rem;
            line-height: 1.1;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        /* --- ANIMAÇÕES DE GOL APRIMORADAS --- */
        @keyframes card-shake {
            0%, 100% { transform: translateY(-4px) scale(1.01) translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateY(-4px) scale(1.01) translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateY(-4px) scale(1.01) translateX(3px); }
        }
        .match-card.goal-shake {
            animation: card-shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes score-flash {
            0%, 100% { transform: scale(1); color: var(--text-primary); }
            50% { transform: scale(1.5); color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        }
        .score-flash-anim {
            animation: score-flash 0.6s ease-in-out;
        }

        .unified-goal-content.animate .unified-goal-text-g {
            opacity: 1 !important;
            animation: goal-g-anim 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .unified-goal-content.animate .unified-goal-text-l {
            opacity: 1 !important;
            animation: goal-l-anim 0.3s ease-out 0.6s forwards; /* Delay para aparecer depois dos 'O's */
        }

        @keyframes goal-g-anim { from { transform: scale(0) rotate(-45deg); opacity: 0; } to { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes goal-l-anim { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .sub-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .sub-icon-in { background-color: #22c55e; color: white; } /* green-500 */
        .sub-icon-out { background-color: #ef4444; color: white; } /* red-500 */

        /* --- ESTILOS DO VAR --- */
        .bg-var-overlay {
            background: linear-gradient(45deg, #1e3a8a, #3730a3);
            color: white;
            overflow: hidden;
        }
        .var-pattern {
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(45deg, rgba(255,255,255,0.05) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(255,255,255,0.05) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.05) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.05) 75%);
            background-size: 20px 20px;
            opacity: 0.5;
        }
        .var-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            text-align: center;
            font-family: 'Roboto Condensed', sans-serif;
            z-index: 2;
        }
        .var-title {
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .var-subtitle {
            font-size: 0.9rem;
            font-weight: 700;
            opacity: 0.8;
            margin-top: 2px;
            padding: 0 1rem;
        }
        .sog-content, .eog-content {
            font-family: 'Roboto Condensed', sans-serif;
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.6);
        }
        .sog-title, .eog-title {
            font-size: 2rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            opacity: 0;
        }
        .sog-subtitle, .eog-subtitle {
            font-size: 1rem;
            font-weight: 700;
            opacity: 0;
            margin-top: 4px;
        }

        @keyframes eog-title-anim {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes eog-subtitle-anim {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .unified-full-overlay.active .sog-title,
        .unified-full-overlay.active .eog-title {
            animation: eog-title-anim 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .unified-full-overlay.active .sog-subtitle,
        .unified-full-overlay.active .eog-subtitle {
            animation: eog-subtitle-anim 0.6s ease-out 0.2s forwards;
        }

        /* --- ESTILOS DO GOL --- */
        .unified-goal-content {
            display: flex;
            align-items: baseline; 
            justify-content: flex-start;
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            font-family: 'Roboto Condensed', sans-serif;
        }

        .unified-goal-text-g {
            opacity: 0;
            font-size: 2.5rem; 
            font-weight: 900;
            line-height: 1;
            margin-right: 2px;
            transform: translateY(3px);
        }

        .unified-goal-text-os {
            opacity: 0;
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: -1px;
        }
        
        .unified-goal-text-l {
            opacity: 0;
            font-size: 1.8rem;
            font-weight: 900;
            margin-left: 1px;
        }

        .match-footer { 
            padding: 10px 20px; background: rgba(0,0,0,0.05); border-top: 1px solid var(--glass-border); 
            display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); font-weight: 500; 
            margin-top: 12px;
        }

        /* Modal Score Display */
        .modal-score-display { 
            font-size: clamp(3.5rem, 10vw, 5.5rem); font-weight: 900; letter-spacing: -2px; line-height: 1;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5); color: #fff; margin-bottom: 10px;
        } /* Usar var(--heading-font-size) */
        body.light-mode .modal-score-display { color: #fff; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* F1 Theme */
        .theme-f1 .league-header { border-bottom: 3px solid #e10600; }
        body.light-mode .theme-f1 .league-header { border-bottom-color: #e10600; }
        .f1-race-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; height: 100%; transition: all 0.3s; box-shadow: var(--card-shadow); }
        .f1-race-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        
        /* General Tables/Grids */
        .std-table-container { overflow-x: auto; border-radius: 20px; border: 1px solid var(--glass-border); background: var(--glass-bg); box-shadow: var(--card-shadow); }
        .std-table-header { display: grid; grid-template-columns: 50px minmax(180px, 3fr) repeat(7, 1fr); padding: 18px 16px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); border-bottom: 1px solid var(--glass-border); background: var(--table-header-bg); align-items: center; text-align: center; min-width: 600px; }
        .std-table-header div:nth-child(2) { text-align: left; } 
        
        .std-row { display: grid; grid-template-columns: 50px minmax(180px, 3fr) repeat(7, 1fr); align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--glass-border); font-size: 0.9rem; transition: background 0.2s; color: var(--text-primary); text-align: center; min-width: 600px; }
        .std-row:hover { background: rgba(128,128,128,0.05); }
        .std-row:last-child { border-bottom: none; }
        .std-row .team-cell { display: flex; align-items: center; gap: 12px; font-weight: 600; text-align: left; overflow: hidden; }
        .std-row .team-cell img { width: 28px; height: 28px; object-fit: contain; flex-shrink: 0; }
        
        /* Rank Badge Customization */
        .rank-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .rank-cell { display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--text-muted); }
        
        /* Colors for Zonas */
        .zone-libertadores { color: var(--zone-libertadores); }
        .bg-libertadores { background-color: var(--zone-libertadores); }
        .zone-prelibertadores { color: var(--zone-prelibertadores); }
        .bg-prelibertadores { background-color: var(--zone-prelibertadores); }
        .zone-sulamericana { color: var(--zone-sulamericana); }
        .bg-sulamericana { background-color: var(--zone-sulamericana); }
        .zone-rebaixamento { color: var(--zone-rebaixamento); }
        .bg-rebaixamento { background-color: var(--zone-rebaixamento); }
        .zone-acesso { color: var(--zone-acesso); }
        .bg-acesso { background-color: var(--zone-acesso); }
        .zone-neutra { color: var(--text-muted); }
        .bg-neutra { background-color: var(--zone-neutra); }

        /* Legend */
        .table-legend { display: flex; flex-wrap: wrap; gap: 16px; padding: 16px; font-size: 0.75rem; color: var(--text-muted); font-weight: 500; border-top: 1px solid var(--glass-border); }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* News & Clubs */
        .news-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; height: 100%; transition: all 0.3s; box-shadow: var(--card-shadow); }
        .news-card:hover { transform: translateY(-8px); border-color: var(--accent); }
        .news-img-wrapper { width: 100%; aspect-ratio: 16 / 9; overflow: hidden; }
        .news-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.6s ease; }
        .news-card:hover .news-img { transform: scale(1.1); }
        .news-content { padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.05)); }
        .news-category { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: var(--accent); margin-bottom: 10px; }
        .news-title { font-size: var(--base-font-size); font-weight: 700; line-height: 1.4; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; color: var(--text-primary); }
        .news-footer { font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; border-top: 1px solid var(--glass-border); padding-top: 12px; }
        
        .club-grid-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; box-shadow: var(--card-shadow); }
        .club-grid-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .club-grid-card img { width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); transition: transform 0.3s; }
        .club-grid-card:hover img { transform: scale(1.1); }
        .club-grid-card span { font-weight: 700; text-align: center; font-size: 1.1rem; color: var(--text-primary); }
        
        .scorer-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px; display: flex; align-items: center; gap: 16px; transition: 0.2s; box-shadow: var(--card-shadow); }
        .scorer-card:hover { border-color: var(--accent); }
        .scorer-rank { font-size: 1.5rem; font-weight: 800; color: var(--accent); width: 30px; text-align: center; }
        .scorer-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--glass-border); }
        .scorer-goals { font-size: 1.4rem; font-weight: 800; color: var(--text-primary); }
        body.light-mode .scorer-goals { color: var(--accent); }

        /* Global Search */
        .search-result-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 12px; cursor: pointer; transition: background 0.2s; color: var(--text-primary); }
        .search-result-item:hover { background: var(--nav-item-hover); }
        .search-result-item img { width: 32px; height: 32px; object-fit: contain; flex-shrink: 0; border-radius: 50%; }
        .search-result-item .result-text .title { font-weight: 600; }
        .search-result-item .result-text .subtitle { font-size: 0.8rem; color: var(--text-muted); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 200; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.4s; } /* Usar var(--blur-intensity) */
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--modal-bg); width: 100%; max-width: 900px; height: 90vh; border-radius: 32px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95) translateY(20px); transition: 0.4s; box-shadow: 0 50px 100px rgba(0,0,0,0.9); }
        .modal-overlay.open .modal-content { transform: scale(1) translateY(0); }
        .modal-header-bg { position: absolute; inset: 0; opacity: 0.2; background-size: cover; background-position: center; filter: blur(40px); }

        /* === TACTICAL BOARD 3D (Modal) === */
        .tactical-board-controls {
            margin: 10px 0 20px;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .btn-formation {
            background: var(--nav-item-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 0.8rem;
        }
        .btn-formation:hover {
            background: var(--nav-item-hover);
            border-color: var(--accent);
        }
        .btn-formation.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-invert);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--ai-glow);
        }
        .stadium-container {
            width: 100%;
            height: 500px;
            perspective: 1200px;
            position: relative;
            margin-top: 10px;
        }
        .pitch {
            width: 100%; height: 100%;
            background: linear-gradient(0deg, #2d6932 50%, #367c3b 50%);
            background-size: 100% 60px;
            position: relative;
            transform: rotateX(45deg) scale(0.9);
            transform-style: preserve-3d;
            border: 2px solid var(--glass-border);
            box-shadow: 0 50px 80px rgba(0,0,0,0.6), inset 0 0 100px rgba(0,0,0,0.3);
            border-radius: 4px;
            transition: transform 0.5s ease;
        }
        .pitch::after { content: ''; position: absolute; inset: 0; background-image: url('https://www.transparenttextures.com/patterns/grass.png'); opacity: 0.15; pointer-events: none; }
        .marking { position: absolute; border: 2px solid rgba(255, 255, 255, 0.7); pointer-events: none; }
        .center-line { top: 50%; left: 0; right: 0; height: 2px; background: rgba(255, 255, 255, 0.7); border: none; }
        .center-circle { top: 50%; left: 50%; width: 120px; height: 120px; transform: translate(-50%, -50%); border-radius: 50%; }
        .penalty-area-top { top: 0; left: 50%; width: 60%; height: 16%; transform: translateX(-50%); }
        .penalty-area-bottom { bottom: 0; left: 50%; width: 60%; height: 16%; transform: translateX(-50%); }
        .goal-area-top { top: 0; left: 50%; width: 30%; height: 6%; transform: translateX(-50%); }
        .goal-area-bottom { bottom: 0; left: 50%; width: 30%; height: 6%; transform: translateX(-50%); }
        .penalty-arc-top { top: 12%; left: 50%; width: 80px; height: 80px; border-radius: 50%; transform: translateX(-50%); clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%); }
        .penalty-arc-bottom { bottom: 12%; left: 50%; width: 80px; height: 80px; border-radius: 50%; transform: translateX(-50%); clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); }
        .goal-post { position: absolute; width: 25%; height: 40px; left: 50%; transform: translateX(-50%) rotateX(-90deg); transform-origin: bottom; border: 2px solid rgba(255,255,255,0.7); background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.1) 10px, rgba(255,255,255,0.1) 20px ); }
        .goal-top { top: -2px; }
        .goal-bottom { bottom: -40px; transform: translateX(-50%) rotateX(-90deg) translateY(-38px); height: 40px;}
        .player {
            position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; height: 60px;
            transform: translate(-50%, -50%) rotateX(-45deg); 
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; z-index: 10;
        }
        .player:hover { z-index: 20; transform: translate(-50%, -55%) rotateX(-45deg) scale(1.1); }
        .kit {
            width: 50px;
            height: 50px;
            border-radius: 10px 10px 4px 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Roboto Condensed', sans-serif;
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
            position: relative;
            padding: 4px 2px;
            box-sizing: border-box;
        }
        .kit-name {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            line-height: 1;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .kit-number {
            font-size: 20px;
            font-weight: 900;
            line-height: 1;
        }
        .player-shadow {
            position: absolute; bottom: 12px; width: 35px; height: 10px;
            background: rgba(0,0,0,0.5); border-radius: 50%;
            transform: rotateX(45deg) translateY(5px);
            filter: blur(2px); z-index: -1;
        }

        main { display: flex; gap: 30px; min-height: 100vh; max-width: 1600px; margin: 0 auto; }
        .sidebar { width: 280px; flex-shrink: 0; position: sticky; top: 90px; height: calc(100vh - 110px); display: flex; flex-direction: column; gap: 20px; }
        .nav-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 24px; padding: 16px; box-shadow: var(--card-shadow); }
        .nav-btn { width: 100%; text-align: left; padding: var(--nav-item-padding); border-radius: var(--nav-item-border-radius); color: var(--text-muted); font-weight: 600; font-size: var(--base-font-size); display: flex; align-items: center; gap: 14px; transition: all 0.2s; }
        .nav-btn:hover, .nav-btn.active { background: var(--nav-item-hover); color: var(--text-primary); }
        .nav-btn.active i { color: var(--accent); }
        .feed { flex: 1; min-width: 0; padding-top: 90px; padding-bottom: 100px; }
        
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px; background: var(--header-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 100px; padding: 10px 24px; display: flex; justify-content: space-between; align-items: center; z-index: 80; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 0.65rem; font-weight: 600; background: none; border: none; cursor: pointer; transition: all 0.3s; }
        .bottom-nav-item.active { color: var(--accent); }
        .bottom-nav-item i { width: 20px; height: 20px; }

        #mob-league-menu { backdrop-filter: blur(16px); background-color: rgba(0,0,0,0.95); }
        body.light-mode #mob-league-menu { background-color: rgba(243, 244, 246, 0.95); }

        /* --- RESPONSIVIDADE AVANÇADA (Ultra Small -> Ultra Wide) --- */
        
        /* 1. Mobile Extra Pequeno (iPhone SE, Galaxy Fold - 320px a 375px) */
        @media (max-width: 375px) {
            .logo-text { font-size: 0.9rem; }
            .header-main { padding: 0 8px; height: 48px; }
            
            /* Ajustes Finos para Placar em Tela Estreita */
            .unified-main-bar { height: 40px; }
            .unified-team-block { padding: 0 8px; }
            .unified-team-abbr { font-size: 1rem; }
            .unified-team-logo { width: 22px; height: 22px; }
            .unified-score-num { font-size: 1.6rem; }
            .unified-league-logo-area img { max-height: 25px; max-width: 25px; }
            .unified-timer-pill { font-size: 0.8rem; padding: 1px 6px 2px 6px; }

            /* Modal Mobile Extra Pequeno */ .modal-content { height: 100vh; width: 100vw; border-radius: 0; } /* Full screen */
            #modal-top-section { height: 120px; }
            .modal-home-logo, .modal-away-logo { width: 40px; height: 40px; margin-bottom: 2px; }
            .modal-score-display { font-size: 2rem; }
            #modal-status { font-size: 9px; padding: 0px 8px; }
            #modal-time { font-size: 10px; margin-top: 1px; font-family: var(--font-family-secondary); }
            .modal-overlay .modal-content > .flex-1 { padding: 10px; } /* Content area padding */
            #modal-timeline { margin-left: 8px; padding-left: 16px; } /* Timeline indent */

            .match-footer { font-size: 0.6rem; padding: 6px 10px; }
            
            .league-header { padding: 10px; margin-bottom: 12px; }
            .league-header img { width: 36px; height: 36px; }
            #page-league-name { font-size: 1.2rem; }
            
            .bottom-nav { padding: 6px 12px; width: 95%; bottom: 12px; }
            .bottom-nav-item { font-size: 0.55rem; }
            .bottom-nav-item i { width: 18px; height: 18px; }
        }

        /* 2. Mobile Padrão (376px - 640px) */
        @media (min-width: 376px) and (max-width: 640px) {
            .sidebar { display: none; }
            .header-main { padding: 0 12px; height: 55px; }
            .feed { padding-top: 70px; padding-left: 0.8rem; padding-right: 0.8rem; }
            .modal-content { height: 95vh; width: 100vw; border-radius: 20px 20px 0 0; position: absolute; bottom: 0; }
            
            /* Modal Mobile Padrão */
            #modal-top-section { height: 150px; }
            .modal-home-logo, .modal-away-logo { width: 60px; height: 60px; margin-bottom: 4px; }
            .modal-score-display { font-size: 2.8rem; }
            #modal-status { font-size: 10px; padding: 1px 10px; font-family: var(--font-family-secondary); }
            #modal-time { font-size: 12px; margin-top: 2px; }
            .modal-overlay .modal-content > .flex-1 { padding: 15px; }
            #modal-timeline { margin-left: 12px; padding-left: 20px; }

            .club-grid-card img { width: 40px; height: 40px; }
            .std-table-header, .std-row { font-size: 0.7rem; padding: 8px; }
            .match-card { margin-bottom: 10px; }
        }

        /* 3. Tablets (640px - 1024px) */
        @media (min-width: 640px) and (max-width: 1024px) {
            .feed { padding-top: 80px; }
            .matches-grid { grid-template-columns: repeat(2, 1fr); }
            .news-grid { grid-template-columns: repeat(2, 1fr); }

            /* Modal Tablets */
            .modal-content { max-width: 700px; height: 85vh; border-radius: 28px; }
            #modal-top-section { height: 200px; }
            .modal-home-logo, .modal-away-logo { width: 80px; height: 80px; }
            .modal-score-display { font-size: 3.5rem; font-family: var(--font-family-primary); }
            .modal-overlay .modal-content > .flex-1 { padding: 20px; }
        }

        /* 4. Desktop (1024px - 1536px) - Padrão (sem necessidade de override aqui) */
        /* 5. Telas Extra Grandes (Ultrawide - > 1536px) */
        @media (min-width: 1536px) {
            main { max-width: 2000px; gap: 50px; } /* Adjusted max-width for main content */
            #page-league-name { font-size: clamp(2.8rem, 4vw, 4.5rem); }
            .match-card:hover { transform: translateY(-8px) scale(1.02); }
            /* Expandir grids */
            #matches-grid { grid-template-columns: repeat(3, 1fr); gap: 28px; }
            #news-grid { grid-template-columns: repeat(4, 1fr); }
            #clubs-grid { grid-template-columns: repeat(6, 1fr); }

            /* Modal Ultrawide Desktop */
            .modal-content { max-width: 1200px; height: 90vh; border-radius: 40px; }
            #modal-top-section { height: 300px; }
            .modal-home-logo, .modal-away-logo { width: 120px; height: 120px; margin-bottom: 8px; }
            .modal-score-display { font-size: 6rem; font-family: var(--font-family-primary); }
            .modal-overlay .modal-content > .flex-1 { padding: 40px 60px; }
            #modal-timeline { margin-left: 24px; padding-left: 40px; }
        }

        /* 6. Mobile Landscape Specific Adjustments (e.g. 16:9 on a phone) */
        @media (orientation: landscape) and (max-height: 500px) {
            .header-main {
                height: 50px;
            }
            .feed {
                /* Adjust padding for smaller header and to save vertical space */
                padding-top: 60px; 
                padding-bottom: 20px;
            }
            .bottom-nav {
                /* Hide bottom nav on landscape mobile, it takes up too much vertical space. */
                display: none;
            }
            .modal-content {
                /* Make modal full screen to maximize space */
                height: 100vh;
                width: 100vw;
                border-radius: 0;
            }
            #modal-top-section {
                height: 120px; /* Keep consistent with portrait extra small */
            }
            .modal-home-logo, .modal-away-logo {
                width: 40px; height: 40px; margin-bottom: 2px; /* Keep consistent with portrait extra small */
            }
            .modal-score-display { font-size: 2rem; font-family: var(--font-family-primary); } /* Keep consistent with portrait extra small */
            .sidebar { display: none; } /* Ensure sidebar is hidden */
        }
    </style>
</head>
<body>

    <div id="app-background"></div>
    <div id="global-loader"><div class="loader-ring"></div><div class="mt-4 text-xs font-bold tracking-[0.3em] text-gray-500">SPORTINGLABS</div></div>

    <!-- Header -->
    <header class="header-main">
        <div class="flex items-center gap-2 md:gap-6">
            <div class="logo-text cursor-pointer flex-shrink-0" onclick="window.location.reload()">Sporting<span>Labs</span></div>
            <div class="hidden md:flex gap-3">
                <div class="relative group">
                    <button class="nav-pill"><span id="header-sport-name">Futebol</span> <i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                    <div class="dropdown-menu group-hover:block absolute top-full left-0 p-2 rounded-xl border border-white/10 hidden z-50 shadow-xl w-64" id="sport-menu"></div>
                </div>
                <div class="relative group">
                    <button class="nav-pill" id="league-selector-btn"><img id="header-league-logo" class="w-4 h-4 rounded-full" src=""> <span id="header-league-name">Carregando...</span> <i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                    <div class="dropdown-menu group-hover:block absolute top-full left-0 p-2 rounded-xl border border-white/10 hidden z-50 shadow-xl w-64" id="league-menu"></div>
                </div>
                <!-- Persona Selector -->
                <div class="relative group">
                    <button class="nav-pill"><span id="header-persona-name">Adulto</span> <i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                    <div class="dropdown-menu group-hover:block absolute top-full left-0 p-2 rounded-xl border border-white/10 hidden z-50 shadow-xl w-48" id="persona-menu">
                        <div class="dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2 text-white" onclick="app.setPersona('young')">
                            <i data-lucide="sparkles" class="w-5 h-5"></i> Jovem Dinâmico</div>
                        <div class="dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2 text-white" onclick="app.setPersona('adult')">
                            <i data-lucide="briefcase" class="w-5 h-5"></i> Adulto</div>
                        <div class="dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2 text-white" onclick="app.setPersona('elderly')">
                            <i data-lucide="glasses" class="w-5 h-5"></i> Idoso</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-2 md:gap-4 ml-auto">
            <!-- Search -->
            <div class="search-container hidden md:block relative w-48 lg:w-64">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                <input type="text" id="global-search-input" class="search-input" placeholder="Buscar..." autocomplete="off">
                <div id="global-search-results" class="absolute top-full left-0 right-0 mt-2 glass-panel p-2 z-50 hidden max-h-80 overflow-y-auto custom-scrollbar">
                    <!-- Search results will be injected here -->
                </div>
            </div>
            
            <!-- Theme Toggle -->
            <button onclick="app.toggleTheme()" class="theme-toggle-btn" title="Alternar Modo Escuro/Claro" aria-label="Alternar tema de cores">
                <i data-lucide="sun" id="theme-icon-sun" class="w-5 h-5 hidden"></i>
                <i data-lucide="moon" id="theme-icon-moon" class="w-5 h-5"></i>
            </button>

            <!-- Mobile League Toggle -->
            <button class="md:hidden nav-pill !p-2 ml-1" onclick="app.toggleMobileLeague()" aria-label="Selecionar liga"><img id="mob-league-logo" class="w-6 h-6 rounded-full" src=""></button>
        </div>
    </header>

    <!-- Mobile League Menu -->
    <div id="mob-league-menu" class="fixed inset-0 z-[80] hidden flex-col p-6 pt-24 overflow-y-auto transition-opacity duration-300">
        <div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Selecionar Liga</h2><button onclick="app.toggleMobileLeague()" class="p-3 rounded-full bg-white/10 hover:bg-white/20"><i data-lucide="x" class="w-6 h-6"></i></button></div>
        <div id="mob-league-list" class="grid grid-cols-1 gap-4"></div>
    </div>

    <!-- Main Content -->
    <main class="container px-4 md:px-0">
        <!-- Sidebar -->
        <aside class="sidebar hidden lg:flex">
            <div class="nav-card">
                <button onclick="app.setView('matches')" class="nav-btn active" id="desk-nav-matches"><i data-lucide="calendar-days"></i> Jogos de Hoje</button>
                <button onclick="app.setView('standings')" class="nav-btn" id="desk-nav-standings"><i data-lucide="trophy"></i> Classificação</button>
                <button onclick="app.setView('scorers')" class="nav-btn" id="desk-nav-scorers"><i data-lucide="target"></i> Artilharia</button>
                <button onclick="app.setView('news')" class="nav-btn" id="desk-nav-news"><i data-lucide="zap"></i> Notícias</button>
                <button onclick="app.setView('clubs')" class="nav-btn" id="desk-nav-clubs"><i data-lucide="shield"></i> Clubes</button>
            </div>
            <div class="nav-card !bg-transparent !border-0 pl-2">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-4 tracking-widest">Ligas Principais</h3>
                <div id="sidebar-league-list" class="space-y-1"></div>
            </div>
        </aside>

        <!-- Feed -->
        <div class="feed" id="main-feed">
            <div class="league-header flex items-center gap-4 md:gap-6 mb-6 md:mb-8 p-6 md:p-8 rounded-3xl bg-white/5 border border-white/10 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-black/50 to-transparent z-0"></div>
                <img id="page-league-logo" class="w-16 h-16 md:w-20 md:h-20 object-contain z-10 drop-shadow-xl" onerror="this.style.display='none'">
                <div class="z-10" style="font-family: var(--font-family-primary);">
                    <h1 id="page-league-name" class="font-black text-white leading-none tracking-tight"></h1>
                    <p class="text-[var(--accent)] font-bold text-xs md:text-sm mt-2 md:mt-3 uppercase tracking-[0.2em]" id="page-league-country"></p>
                </div>
            </div>

            <!-- View: Matches -->
            <div id="view-matches" class="view-section">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 md:mb-8 px-2 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xl md:text-2xl font-bold" style="color: var(--text-primary); font-family: var(--font-family-primary);">Partidas</h2>
                        <span id="live-indicator" class="hidden px-3 py-1 bg-[var(--accent)] text-black text-[11px] font-extrabold rounded-full animate-pulse">AO VIVO</span>
                    </div>
                    <input type="text" id="date-picker" class="bg-white/5 border border-white/10 text-white text-sm rounded-xl px-4 py-2 w-full sm:w-36 text-center cursor-pointer hover:bg-white/10 transition outline-none focus:border-[var(--accent)]" placeholder="Hoje" style="color: var(--text-primary); background: var(--input-bg); border-color: var(--glass-border)">
                </div>
                <!-- Responsive Grid: 1 col mobile, 2 col lg, 3 col 2xl -->
                <div id="matches-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6"></div>
            </div>

            <!-- View: Standings -->
            <div id="view-standings" class="view-section hidden">
                <div class="section-title mb-8 text-2xl font-bold border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary); font-family: var(--font-family-primary);">Tabela</div>
                <div id="standings-container" class="std-table-container"></div>
                <div id="standings-legend" class="table-legend"></div>
            </div>

            <!-- View: Scorers -->
            <div id="view-scorers" class="view-section hidden">
                <div id="scorers-header" class="flex justify-between items-center mb-8" style="font-family: var(--font-family-primary);">
                    <div class="section-title !mb-0 text-xl md:text-2xl font-bold border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary)">Artilheiros</div>
                    <select id="season-selector" class="bg-white/5 border border-white/10 text-white text-sm rounded-xl px-4 py-2 cursor-pointer outline-none" style="color: var(--text-primary); background: var(--input-bg); border-color: var(--glass-border)"></select>
                </div>
                <div id="scorers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <!-- View: News -->
            <div id="view-news" class="view-section hidden">
                <div class="section-title mb-8 text-2xl font-bold border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary); font-family: var(--font-family-primary);">Últimas Notícias</div>
                <!-- Responsive Grid: 1 col mobile, 2 col sm, 3 col lg, 4 col xl -->
                <div id="news-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-8"></div>
            </div>

            <!-- View: Clubs -->
            <div id="view-clubs" class="view-section hidden">
                <div class="text-2xl font-bold mb-8 border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary)">Clubes da Liga</div>
                <div class="mb-10 relative max-w-xl" style="font-family: var(--font-family-primary);">
                    <input type="text" id="wiki-search-input" class="search-input !py-4 !text-lg !pl-14" placeholder="Pesquisar na Wikipedia...">
                    <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <!-- Responsive Grid: 2 col mobile, 3 sm, 4 md, 5 lg, 6 xl -->
                <div id="clubs-grid" class="grid grid-cols-2 min-[450px]:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-6"></div>
            </div>

            <!-- View: F1 Schedule -->
            <div id="view-schedule" class="view-section hidden">
                <div class="section-title mb-8 text-2xl font-bold border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary); font-family: var(--font-family-primary);">Calendário da Fórmula 1</div>
                <div id="schedule-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6"></div>
            </div>

            <!-- View: F1 Driver Standings -->
            <div id="view-driver-standings" class="view-section hidden">
                <div class="section-title mb-8 text-2xl font-bold border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary); font-family: var(--font-family-primary);">Mundial de Pilotos</div>
                <div id="driver-standings-container" class="std-table-container"></div>
            </div>

            <!-- View: F1 Team Standings -->
            <div id="view-team-standings" class="view-section hidden">
                <div class="section-title mb-8 text-2xl font-bold border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary); font-family: var(--font-family-primary);">Mundial de Construtores</div>
                <div id="team-standings-container" class="std-table-container">
                    <div class="std-table-header" style="grid-template-columns: 50px minmax(180px, 3fr) 1fr; font-family: var(--font-family-primary);"><div>#</div><div class="text-left">Equipe</div><div class="text-center">Pts</div></div>
                    <div id="team-standings-body"></div>
                </div>
            </div>

            <!-- View: F1 Historic Pilots -->
            <div id="view-historic-pilots" class="view-section hidden">
                <div class="section-title mb-8 text-2xl font-bold border-l-4 border-[var(--accent)] pl-4" style="color: var(--text-primary)">Pilotos Históricos</div>
                <div class="mb-10 relative max-w-xl" style="font-family: var(--font-family-primary);">
                    <input type="text" id="wiki-pilot-search-input" class="search-input !py-4 !text-lg !pl-14" placeholder="Pesquisar piloto na Wikipedia...">
                    <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="historic-pilots-grid" class="grid grid-cols-2 min-[450px]:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-6"></div>
            </div>

            <!-- View: Team Schedule -->
            <div id="view-team-schedule" class="view-section hidden">
                <!-- Content rendered by JS -->
            </div>

            <!-- Shared Wiki Detail View -->
            <div id="wiki-detail" class="hidden">
                <button onclick="app.closeWiki()" class="mb-6 text-[var(--accent)] hover:text-white transition flex items-center gap-2 font-bold"><i data-lucide="arrow-left"></i> Voltar</button>
                <div id="wiki-content-area" class="wiki-detail-content glass-panel p-8" style="color: var(--text-primary); font-family: var(--font-family-primary);"></div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav lg:hidden">
        <button class="bottom-nav-item active" onclick="app.setView('matches')" id="mob-nav-matches"><i data-lucide="calendar-days"></i><span>Jogos</span></button>
        <button class="bottom-nav-item" onclick="app.setView('standings')" id="mob-nav-standings"><i data-lucide="trophy"></i><span>Tabela</span></button>
        <button class="bottom-nav-item" onclick="app.setView('scorers')" id="mob-nav-scorers"><i data-lucide="target"></i><span>Gols</span></button>
        <button class="bottom-nav-item" onclick="app.setView('news')" id="mob-nav-news"><i data-lucide="zap"></i><span>News</span></button>
        <button class="bottom-nav-item" onclick="app.setView('clubs')" id="mob-nav-clubs"><i data-lucide="shield"></i><span>Clubes</span></button>
    </nav>

    <!-- F1 Race Detail Modal -->
    <div id="f1-race-modal" class="modal-overlay">
        <div class="modal-content"> 
            <div id="f1-modal-top-section" class="relative h-[200px] md:h-[250px] flex flex-col items-center justify-center border-b border-white/10 shrink-0 p-6">
                <div class="modal-header-bg" id="f1-modal-bg"></div>
                <div class="relative z-10 text-center">
                    <p id="f1-modal-circuit" class="text-[var(--accent)] font-bold uppercase text-xs tracking-[0.2em] mb-2" style="font-family: var(--font-family-secondary);"></p>
                    <h2 id="f1-modal-racename" class="text-2xl md:text-4xl font-black text-white leading-tight">Race Name</h2>
                    <p id="f1-modal-date" class="text-gray-400 text-sm md:text-base mt-2 font-medium"></p>
                </div>
                <button onclick="app.closeF1Modal()" class="absolute top-4 right-4 md:top-6 md:right-6 text-white/50 hover:text-white z-20 bg-black/40 p-2 md:p-3 rounded-full backdrop-blur-md transition hover:bg-white/20" aria-label="Fechar modal"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
                <div id="f1-modal-tabs" class="flex items-center border-b border-white/10 mb-6 overflow-x-auto"></div>
                <div id="f1-modal-content"></div>
            </div>
        </div>
    </div>

    <!-- Match Detail Modal -->
    <div id="match-modal" class="modal-overlay">
        <div class="modal-content"> 
            <div id="modal-top-section" class="relative h-[200px] md:h-[250px] flex flex-col items-center justify-center border-b border-white/10 shrink-0">
                <div class="modal-header-bg" id="modal-bg"></div>
                <div class="relative z-10 w-full px-4 md:px-12 flex justify-between items-center mt-4">
                    <div class="flex flex-col items-center w-1/3 text-center">
                        <img id="modal-home-logo" class="w-16 h-16 md:w-24 md:h-24 object-contain mb-2 md:mb-4 drop-shadow-2xl">
                        <h2 id="modal-home-name" class="text-xs md:text-xl font-black text-white leading-tight">HOME</h2>
                    </div> 
                    <div class="flex flex-col items-center">
                        <div class="modal-score-display" id="modal-score">0 - 0</div>
                        <div id="modal-status" class="text-[var(--accent)] font-bold uppercase text-[10px] md:text-xs tracking-[0.2em] bg-black/60 px-3 md:px-4 py-1 rounded-full backdrop-blur-md border border-white/10 mt-2 md:mt-3" style="font-family: var(--font-family-secondary);">AO VIVO</div>
                        <div id="modal-time" class="text-gray-400 text-xs md:text-sm mt-2 font-mono"></div>
                    </div>
                    <div class="flex flex-col items-center w-1/3 text-center">
                        <img id="modal-away-logo" class="w-16 h-16 md:w-24 md:h-24 object-contain mb-2 md:mb-4 drop-shadow-2xl">
                        <h2 id="modal-away-name" class="text-xs md:text-xl font-black text-white leading-tight">AWAY</h2>
                    </div>
                </div>
                <button onclick="app.closeModal()" class="absolute top-4 right-4 md:top-6 md:right-6 text-white/50 hover:text-white z-20 bg-black/40 p-2 md:p-3 rounded-full backdrop-blur-md transition hover:bg-white/20" aria-label="Fechar modal"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
                <div id="match-modal-tabs" class="flex items-center border-b border-white/10 shrink-0 px-4 md:px-10">
                    <!-- Tabs will be injected by JS -->
                </div>
                <div class="flex-1 overflow-y-auto p-4 md:p-10 custom-scrollbar">
                    <div id="match-tab-summary" class="match-tab-pane">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                            <div><h3 class="text-xs font-bold text-gray-500 uppercase mb-6 tracking-widest border-b border-white/5 pb-2" style="font-family: var(--font-family-secondary);">Estatísticas</h3><div id="modal-stats" class="space-y-6"></div></div>
                            <div><h3 class="text-xs font-bold text-gray-500 uppercase mb-6 tracking-widest border-b border-white/5 pb-2" style="font-family: var(--font-family-secondary);">Linha do Tempo</h3><div id="modal-timeline" class="relative ml-4"></div></div>
                        </div>
                    </div>
                    <div id="match-tab-lineups" class="match-tab-pane hidden">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-6 tracking-widest border-b border-white/5 pb-2">Formações Táticas</h3>
                        <div id="modal-lineups" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                            <div id="home-lineup"></div>
                            <div id="away-lineup"></div>
                        </div>
                    </div>
                    <div id="match-tab-broadcast" class="match-tab-pane hidden">
                        <!-- Broadcast channels will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ERRO CRÍTICO DE SEGURANÇA: A chave da API nunca deve ser exposta no código do lado do cliente (frontend).
        // Isso permite que qualquer pessoa a roube e use sua assinatura.
        // A chave foi substituída por um placeholder. O ideal é fazer essas chamadas a partir de um backend seguro.
        const APIFOOTBALL_KEY = "9c617e9d2b646ee084b312546b1974fe"; 
        
        // NOTA DE QUALIDADE DE CÓDIGO: Bancos de dados grandes como PLAYER_DB_DATA e SPORTS_DB devem ser carregados de arquivos .json ou .js externos
        // para não inflar o tamanho do arquivo HTML inicial e melhorar o tempo de carregamento.
        // Base de dados de jogadores. Você pode expandir esta lista com mais de 2000 jogadores.
        const PLAYER_DB_DATA = {
          "soccer": {
            "bra.1": [
              { "id": 1, "name": "Givanildo Vieira de Sousa", "commonName": "Hulk", "nationality": "Brasil" },
              { "id": 2, "name": "Gabriel Barbosa Almeida", "commonName": "Gabigol", "nationality": "Brasil" },
              { "id": 3, "name": "Marcos Leonardo Santos Almeida", "commonName": "Marcos Leonardo", "nationality": "Brasil" },
              { "id": 4, "name": "Raphael Cavalcante Veiga", "commonName": "Raphael Veiga", "nationality": "Brasil" },
              { "id": 5, "name": "Cássio Ramos", "commonName": "Cássio", "nationality": "Brasil" },
              { "id": 6, "name": "Weverton Pereira da Silva", "commonName": "Weverton", "nationality": "Brasil" },
              { "id": 7, "name": "Giorgian De Arrascaeta", "commonName": "Arrascaeta", "nationality": "Uruguai" },
              { "id": 8, "name": "Pedro Guilherme Abreu dos Santos", "commonName": "Pedro", "nationality": "Brasil" },
              { "id": 9, "name": "Germán Cano", "commonName": "Cano", "nationality": "Argentina" },
              { "id": 10, "name": "Jhon Arias", "commonName": "Jhon Arias", "nationality": "Colômbia" },
              { "id": 11, "name": "Tiquinho Soares", "commonName": "Tiquinho", "nationality": "Brasil" },
              { "id": 12, "name": "Paulinho", "commonName": "Paulinho", "nationality": "Brasil" },
              { "id": 13, "name": "Luis Suárez", "commonName": "Suárez", "nationality": "Uruguai" },
              { "id": 14, "name": "André Trindade da Costa Neto", "commonName": "André", "nationality": "Brasil" },
              { "id": 15, "name": "Endrick Felipe Moreira de Sousa", "commonName": "Endrick", "nationality": "Brasil" },
              { "id": 16, "name": "Vitor Roque", "commonName": "Vitor Roque", "nationality": "Brasil" },
              { "id": 17, "name": "Renato Augusto", "commonName": "Renato Augusto", "nationality": "Brasil" },
              { "id": 18, "name": "Gustavo Gómez", "commonName": "G. Gómez", "nationality": "Paraguai" },
              { "id": 19, "name": "Fagner Conserva Lemos", "commonName": "Fagner", "nationality": "Brasil" },
              { "id": 20, "name": "Marcelo Vieira da Silva Júnior", "commonName": "Marcelo", "nationality": "Brasil" }
            ],
            "premier": [
              { "id": 101, "name": "Erling Haaland", "commonName": "Haaland", "nationality": "Noruega" },
              { "id": 102, "name": "Mohamed Salah", "commonName": "Salah", "nationality": "Egito" },
              { "id": 103, "name": "Kevin De Bruyne", "commonName": "De Bruyne", "nationality": "Bélgica" },
              { "id": 104, "name": "Bukayo Saka", "commonName": "Saka", "nationality": "Inglaterra" },
              { "id": 105, "name": "Martin Ødegaard", "commonName": "Ødegaard", "nationality": "Noruega" },
              { "id": 106, "name": "Declan Rice", "commonName": "Rice", "nationality": "Inglaterra" },
              { "id": 107, "name": "Marcus Rashford", "commonName": "Rashford", "nationality": "Inglaterra" },
              { "id": 108, "name": "Bruno Fernandes", "commonName": "Bruno Fernandes", "nationality": "Portugal" },
              { "id": 109, "name": "Virgil van Dijk", "commonName": "van Dijk", "nationality": "Holanda" },
              { "id": 110, "name": "Alisson Becker", "commonName": "Alisson", "nationality": "Brasil" },
              { "id": 111, "name": "Son Heung-min", "commonName": "Son", "nationality": "Coreia do Sul" },
              { "id": 112, "name": "Enzo Fernández", "commonName": "Enzo Fernández", "nationality": "Argentina" },
              { "id": 113, "name": "Rodri", "commonName": "Rodri", "nationality": "Espanha" },
              { "id": 114, "name": "Phil Foden", "commonName": "Foden", "nationality": "Inglaterra" },
              { "id": 115, "name": "Trent Alexander-Arnold", "commonName": "Alexander-Arnold", "nationality": "Inglaterra" },
              { "id": 116, "name": "Casemiro", "commonName": "Casemiro", "nationality": "Brasil" },
              { "id": 117, "name": "Bernardo Silva", "commonName": "Bernardo Silva", "nationality": "Portugal" },
              { "id": 118, "name": "Jack Grealish", "commonName": "Grealish", "nationality": "Inglaterra" },
              { "id": 119, "name": "Darwin Núñez", "commonName": "Núñez", "nationality": "Uruguai" },
              { "id": 120, "name": "Julián Álvarez", "commonName": "J. Álvarez", "nationality": "Argentina" }
            ],
            "laliga": [
                { "id": 201, "name": "Vinícius José Paixão de Oliveira Júnior", "commonName": "Vini Jr.", "nationality": "Brasil" },
                { "id": 202, "name": "Jude Bellingham", "commonName": "Bellingham", "nationality": "Inglaterra" },
                { "id": 203, "name": "Robert Lewandowski", "commonName": "Lewandowski", "nationality": "Polônia" },
                { "id": 204, "name": "Antoine Griezmann", "commonName": "Griezmann", "nationality": "França" },
                { "id": 205, "name": "Pedri", "commonName": "Pedri", "nationality": "Espanha" },
                { "id": 206, "name": "Gavi", "commonName": "Gavi", "nationality": "Espanha" },
                { "id": 207, "name": "Federico Valverde", "commonName": "Valverde", "nationality": "Uruguai" },
                { "id": 208, "name": "Rodrygo Goes", "commonName": "Rodrygo", "nationality": "Brasil" },
                { "id": 209, "name": "Luka Modrić", "commonName": "Modrić", "nationality": "Croácia" },
                { "id": 210, "name": "Frenkie de Jong", "commonName": "de Jong", "nationality": "Holanda" },
                { "id": 211, "name": "Iago Aspas", "commonName": "Iago Aspas", "nationality": "Espanha" },
                { "id": 212, "name": "Thibaut Courtois", "commonName": "Courtois", "nationality": "Bélgica" },
                { "id": 213, "name": "Ronald Araújo", "commonName": "Araújo", "nationality": "Uruguai" },
                { "id": 214, "name": "Toni Kroos", "commonName": "Kroos", "nationality": "Alemanha" },
                { "id": 215, "name": "João Félix", "commonName": "João Félix", "nationality": "Portugal" },
                { "id": 216, "name": "Éder Militão", "commonName": "Militão", "nationality": "Brasil" }
            ],
            "ita.1": [
                { "id": 301, "name": "Victor Osimhen", "commonName": "Osimhen", "nationality": "Nigéria" },
                { "id": 302, "name": "Lautaro Martínez", "commonName": "Lautaro", "nationality": "Argentina" },
                { "id": 303, "name": "Rafael Leão", "commonName": "Rafael Leão", "nationality": "Portugal" },
                { "id": 304, "name": "Khvicha Kvaratskhelia", "commonName": "Kvaratskhelia", "nationality": "Geórgia" },
                { "id": 305, "name": "Nicolò Barella", "commonName": "Barella", "nationality": "Itália" },
                { "id": 306, "name": "Federico Chiesa", "commonName": "Chiesa", "nationality": "Itália" },
                { "id": 307, "name": "Paulo Dybala", "commonName": "Dybala", "nationality": "Argentina" },
                { "id": 308, "name": "Dušan Vlahović", "commonName": "Vlahović", "nationality": "Sérvia" },
                { "id": 309, "name": "Theo Hernández", "commonName": "Theo Hernández", "nationality": "França" },
                { "id": 310, "name": "Ciro Immobile", "commonName": "Immobile", "nationality": "Itália" },
                { "id": 311, "name": "Mike Maignan", "commonName": "Maignan", "nationality": "França" }
            ],
            "ger.1": [
                { "id": 401, "name": "Harry Kane", "commonName": "Kane", "nationality": "Inglaterra" },
                { "id": 402, "name": "Jamal Musiala", "commonName": "Musiala", "nationality": "Alemanha" },
                { "id": 403, "name": "Florian Wirtz", "commonName": "Wirtz", "nationality": "Alemanha" },
                { "id": 404, "name": "Leroy Sané", "commonName": "Sané", "nationality": "Alemanha" },
                { "id": 405, "name": "Joshua Kimmich", "commonName": "Kimmich", "nationality": "Alemanha" },
                { "id": 406, "name": "Marco Reus", "commonName": "Reus", "nationality": "Alemanha" },
                { "id": 407, "name": "Julian Brandt", "commonName": "Brandt", "nationality": "Alemanha" },
                { "id": 408, "name": "Thomas Müller", "commonName": "Müller", "nationality": "Alemanha" },
                { "id": 409, "name": "Manuel Neuer", "commonName": "Neuer", "nationality": "Alemanha" },
                { "id": 410, "name": "Alphonso Davies", "commonName": "Davies", "nationality": "Canadá" }
            ],
            "ksa.1": [
                { "id": 501, "name": "Cristiano Ronaldo", "commonName": "C. Ronaldo", "nationality": "Portugal" },
                { "id": 502, "name": "Neymar da Silva Santos Júnior", "commonName": "Neymar Jr.", "nationality": "Brasil" },
                { "id": 503, "name": "Karim Benzema", "commonName": "Benzema", "nationality": "França" },
                { "id": 504, "name": "N'Golo Kanté", "commonName": "Kanté", "nationality": "França" },
                { "id": 505, "name": "Sadio Mané", "commonName": "Mané", "nationality": "Senegal" },
                { "id": 506, "name": "Riyad Mahrez", "commonName": "Mahrez", "nationality": "Argélia" },
                { "id": 507, "name": "Roberto Firmino", "commonName": "Firmino", "nationality": "Brasil" },
                { "id": 508, "name": "Fabinho", "commonName": "Fabinho", "nationality": "Brasil" },
                { "id": 509, "name": "Sergej Milinković-Savić", "commonName": "Milinković-Savić", "nationality": "Sérvia" },
                { "id": 510, "name": "Kalidou Koulibaly", "commonName": "Koulibaly", "nationality": "Senegal" },
                { "id": 511, "name": "Marcelo Brozović", "commonName": "Brozović", "nationality": "Croácia" }
            ]
          }
        };
        
        const SPORTS_DB = {
            "soccer": {
                name: "Futebol",
                logo: "https://cdn-icons-png.flaticon.com/512/53/53283.png",
                views: [
                    { id: 'matches', name: 'Jogos', icon: 'calendar-days' },
                    { id: 'standings', name: 'Classificação', icon: 'trophy' },
                    { id: 'scorers', name: 'Artilharia', icon: 'target' },
                    { id: 'news', name: 'Notícias', icon: 'zap' },
                    { id: 'clubs', name: 'Clubes', icon: 'shield' },
                ],
                leagues: {
                    "brasileirao": { 
                        id: "bra.1", apiFootballId: 71, seasonId: 2026, name: "Brasileirão Série A", 
                        logo: "https://upload.wikimedia.org/wikipedia/pt/7/75/Campeonato_Brasileiro_de_Futebol_de_2024_-_S%C3%A9rie_A.png", 
                        bg: "https://s2-globo-play.glbimg.com/rHTMAA96-XWwbs6h4pEWeZXlREw=/https://s2.glbimg.com/aNGo_xeD86fO2XMCGBRlpe7rmmg=/i.s3.glbimg.com/v1/AUTH_c3c606ff68e7478091d1ca496f9c5625/internal_photos/bs/2025/L/P/Y3zKUbSTWAUtZN86BTzg/2025-4731-brasileirao-background.jpg",
                        clubs: ["Clube_Atlético_Mineiro", "Esporte_Clube_Bahia", "Botafogo_de_Futebol_e_Regatas", "Ceará_Sporting_Club", "Sport_Club_Corinthians_Paulista", "Cruzeiro_Esporte_Clube", "Clube_de_Regatas_do_Flamengo", "Fluminense_Football_Club", "Fortaleza_Esporte_Clube", "Grêmio_Foot-Ball_Porto_Alegrense", "Sport_Club_Internacional", "Esporte_Clube_Juventude", "Mirassol_Futebol_Clube", "Sociedade_Esportiva_Palmeiras", "Red_Bull_Bragantino", "Santos_Futebol_Clube", "São_Paulo_Futebol_Clube", "Sport_Club_do_Recife", "Club_de_Regatas_Vasco_da_Gama", "Esporte_Clube_Vitória"]
                    },
                    "brasileiraob": { 
                        id: "bra.2", apiFootballId: 72, seasonId: 2026, name: "Brasileirão Série B", 
                        logo: "https://upload.wikimedia.org/wikipedia/pt/thumb/2/2d/Campeonato_Brasileiro_de_Futebol_S%C3%A9rie_B_2025.png/250px-Campeonato_Brasileiro_de_Futebol_S%C3%A9rie_B_2025.png", 
                        bg: "https://assets.goal.com/images/v3/bltcc999d0167120e29/brasileir%C3%A3o_s%C3%A9rie_b_ta%C3%A7a.jpg?auto=webp&format=pjpg&width=3840&quality=60",
                        clubs: ["Amazonas_Futebol_Clube", "América_Futebol_Clube_(Minas_Gerais)", "Athletic_Club_(Minas_Gerais)", "Club_Athletico_Paranaense", "Atlético_Clube_Goianiense", "Avaí_Futebol_Clube", "Botafogo_Futebol_Clube_(Ribeirão_Preto)", "Associação_Chapecoense_de_Futebol", "Coritiba_Foot_Ball_Club", "Clube_de_Regatas_Brasil", "Criciúma_Esporte_Clube", "Cuiabá_Esporte_Clube", "Associação_Ferroviária_de_Esportes", "Goiás_Esporte_Clube", "Grêmio_Novorizontino", "Operário_Ferroviário_Esporte_Clube", "Paysandu_Sport_Club", "Clube_do_Remo", "Vila_Nova_Futebol_Clube", "Volta_Redonda_Futebol_Clube"]
                    },
                    "premier": { 
                        id: "eng.1", apiFootballId: 39, seasonId: 2026, name: "Premier League", 
                        logo: "https://a.espncdn.com/i/leaguelogos/soccer/500/23.png", 
                        bg: "https://t4.ftcdn.net/jpg/05/99/15/97/360_F_599159727_pFIXrrEiyZnuSw5h0qOjAuVMeQfTYpQM.jpg",
                        clubs: ["Arsenal_Football_Club", "Aston_Villa_Football_Club", "A.F.C._Bournemouth", "Brentford_Football_Club", "Brighton_&_Hove_Albion_Football_Club", "Chelsea_Football_Club", "Crystal_Palace_Football_Club", "Everton_Football_Club", "Fulham_Football_Club", "Ipswich_Town_Football_Club", "Leicester_City_Football_Club", "Liverpool_Football_Club", "Manchester_City_Football_Club", "Manchester_United_Football_Club", "Newcastle_United_Football_Club", "Nottingham_Forest_Football_Club", "Southampton_Football_Club", "Tottenham_Hotspur_Football_Club", "West_Ham_United_Football_Club", "Wolverhampton_Wanderers_Football_Club"]
                    },
                    "laliga": { 
                        id: "esp.1", apiFootballId: 140, seasonId: 2026, name: "La Liga", 
                        logo: "https://a.espncdn.com/i/leaguelogos/soccer/500/15.png", 
                        bg: "https://assets.goal.com/images/v3/blt054a5ddddf1e5a2b/158f203189e94419d7010667f379da35bcf16d8e.jpg",
                        clubs: ["Deportivo_Alavés", "Athletic_Club", "Atlético_de_Madrid", "Futbol_Club_Barcelona", "Real_Betis_Balompié", "Real_Club_Celta_de_Vigo", "Real_Club_Deportivo_Espanyol_de_Barcelona", "Getafe_Club_de_Fútbol", "Girona_Futbol_Club", "Unión_Deportiva_Las_Palmas", "Club_Deportivo_Leganés", "Real_Club_Deportivo_Mallorca", "Club_Atlético_Osasuna", "Rayo_Vallecano_de_Madrid", "Real_Madrid_Club_de_Fútbol", "Real_Sociedad_de_Fútbol", "Sevilla_Fútbol_Club", "Valencia_Club_de_Fútbol", "Real_Valladolid", "Villarreal_Club_de_Fútbol"]
                    },
                    "champions": { 
                        id: "uefa.champions", apiFootballId: 2, seasonId: 2026, name: "Champions League", 
                        logo: "https://a.espncdn.com/i/leaguelogos/soccer/500/2.png", 
                        bg: "https://editorial.uefa.com/resources/027f-1793cd516cbd-e4e5d9d1aedf-1000/fbl-eur-c1-draw.jpeg",
                        clubs: ["Real_Madrid_Club_de_Fútbol", "Futbol_Club_Barcelona", "Atlético_de_Madrid", "Manchester_City_Football_Club", "Arsenal_Football_Club", "Liverpool_Football_Club", "Manchester_United_Football_Club", "Fußball-Club_Bayern_München", "Borussia_Dortmund", "Bayer_04_Leverkusen", "RB_Leipzig", "Paris_Saint-Germain_Football_Club", "Internazionale_Milano", "Associazione_Calcio_Milan", "Juventus_Football_Club", "Philips_Sport_Vereniging", "Feyenoord_Rotterdam", "Sport_Lisboa_e_Benfica", "Futebol_Clube_do_Porto", "Sporting_Clube_de_Portugal"]
                    },
                    "libertadores": { 
                        id: "conmebol.libertadores", apiFootballId: 13, seasonId: 2026, name: "Libertadores", 
                        logo: "https://upload.wikimedia.org/wikipedia/pt/4/4b/Conmebol_Libertadores_Bridgestone_logo.png", 
                        bg: "https://lncimg.lance.com.br/cdn-cgi/image/width=950,quality=75,fit=pad,format=webp/uploads/2021/01/29/60141dfea45a6.jpeg",
                        clubs: ["Clube_de_Regatas_do_Flamengo", "Sociedade_Esportiva_Palmeiras", "São_Paulo_Futebol_Clube", "Fluminense_Football_Club", "Grêmio_Foot-Ball_Porto_Alegrense", "Sport_Club_Internacional", "Clube_Atlético_Mineiro", "Club_Atlético_Boca_Juniors", "Club_Atlético_River_Plate", "Racing_Club_de_Avellaneda", "Club_Atlético_Independiente", "Club_Atlético_San_Lorenzo_de_Almagro", "Club_Atlético_Peñarol", "Club_Nacional_de_Football", "Club_Olimpia", "Club_Cerro_Porteño", "Colo-Colo", "Club_Universidad_de_Chile", "Atlético_Nacional", "Liga_Deportiva_Universitaria_de_Quito"]
                    },
                    "seriea": { 
                        id: "ita.1", apiFootballId: 135, seasonId: 2026, name: "Serie A", 
                        logo: "https://a.espncdn.com/i/leaguelogos/soccer/500/12.png", 
                        bg: "https://cloudfront-us-east-1.images.arcpublishing.com/newr7/L6ZP3CEJ6VMPNFT5HTW7H7L7LY.jpg",
                        clubs: ["Atalanta_Bergamasca_Calcio", "Bologna_Football_Club_1909", "Cagliari_Calcio", "Como_1907", "Empoli_Football_Club", "ACF_Fiorentina", "Genoa_Cricket_and_Football_Club", "Internazionale_Milano", "Juventus_Football_Club", "Società_Sportiva_Lazio", "Unione_Sportiva_Lecce", "Associazione_Calcio_Milan", "Associazione_Calcio_Monza", "Società_Sportiva_Calcio_Napoli", "Parma_Calcio_1913", "Associazione_Sportiva_Roma", "Torino_Football_Club", "Udinese_Calcio", "Venezia_Football_Club", "Hellas_Verona_Football_Club"]
                    },
                    "bundesliga": { 
                        id: "ger.1", apiFootballId: 78, seasonId: 2026, name: "Bundesliga", 
                        logo: "https://a.espncdn.com/i/leaguelogos/soccer/500/10.png", 
                        bg: "https://s2-ge.glbimg.com/F2PP74GbwM16ougDWVMDhZzEp6U=/0x0:1024x659/984x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_bc8228b6673f488aa253bbcb03c80ec5/internal_photos/bs/2024/X/Y/3pfuBhTzuraB6EHOqszA/gettyimages-1742744089.jpg",
                        clubs: ["Bayer_04_Leverkusen", "VfB_Stuttgart", "Fußball-Club_Bayern_München", "RB_Leipzig", "Borussia_Dortmund", "Eintracht_Frankfurt", "TSG_1899_Hoffenheim", "1._FC_Heidenheim_1846", "SV_Werder_Bremen", "SC_Freiburg", "FC_Augsburg", "VfL_Wolfsburg", "1._FSV_Mainz_05", "Borussia_Mönchengladbach", "1._FC_Union_Berlin", "VfL_Bochum", "FC_St._Pauli", "Holstein_Kiel", "Hamburger_SV", "FC_Schalke_04"]
                    },
                    "saudi": { 
                        id: "ksa.1", apiFootballId: 307, seasonId: 2026, name: "Saudi Pro League", 
                        logo: "https://a4.espncdn.com/combiner/i?img=%2Fi%2Fleaguelogos%2Fsoccer%2F500%2F2488.png", 
                        bg: "https://www.365scores.com/pt-br/news/magazine/wp-content/uploads/2023/11/366423961_5646928382077000_2604818796297545939_n-e1699379331310.jpg",
                        clubs: ["Al-Ahli_Saudi_FC", "Al-Ettifaq_FC", "Al-Fateh_SC", "Al-Fayha_FC", "Al-Hilal_Saudi_Football_Club", "Al-Ittihad_Club", "Al-Khaleej_FC", "Al-Nassr_FC", "Al-Okhdood_Club", "Al-Qadsiah_FC", "Al-Raed_FC", "Al-Riyadh_SC", "Al-Shabab_Football_Club", "Al-Taawoun_FC", "Al-Wehda_Football_Club", "Damac_Football_Club", "Al-Kholood_Club", "Al-Orobah_FC", "Abha_Club", "Al-Hazem_SC"]
                    }
                    ,
                    "paulista": { 
                        id: "bra.camp.paulista", apiFootballId: null, seasonId: 2026, name: "Paulistão", 
                        logo: "https://upload.wikimedia.org/wikipedia/pt/1/1c/Paulist%C3%A3o_2026.png", 
                        bg: "https://www.infomoney.com.br/wp-content/uploads/2025/03/copapaulistamar25-e1743017283823.jpg?fit=2500%2C1167&quality=50&strip=all",
                        clubs: ["Sport_Club_Corinthians_Paulista", "Sociedade_Esportiva_Palmeiras", "Red_Bull_Bragantino", "Santos_Futebol_Clube", "São_Paulo_Futebol_Clube", "Esporte_Clube_Água_Santa", "Associação_Atlética_Ponte_Preta", "Associação_Portuguesa_de_Desportos", "Botafogo_Futebol_Clube_(Ribeirão_Preto)", "Guarani_Futebol_Clube", "Grêmio_Novorizontino", "Mirassol_Futebol_Clube", "Esporte_Clube_Noroeste", "Esporte_Clube_Santo_André", "Esporte_Clube_São_Bento", "Velo_Clube_Rioclarense"]
                    },
                    "carioca": { 
                        id: "bra.camp.carioca", apiFootballId: null, seasonId: 2026, name: "Cariocão", 
                        logo: "https://upload.wikimedia.org/wikipedia/pt/3/3c/Carioca_2020_FERJ.jpg", 
                        bg: "https://i.metroimg.com/CN9inuWAEomvLQLMnCj7IjGrN5YQ9SZhw7Tbi1tIHjs/w:900/q:85/f:webp/plain/https://www.metropoles.com/wp-content/uploads/wp-content/uploads/2025/03/16165052/Taca-do-Campeonato-Carioca-1.jpg",
                        clubs: ["Bangu_Atlético_Clube", "Boavista_Sport_Club", "Botafogo_de_Futebol_e_Regatas", "Clube_de_Regatas_do_Flamengo", "Fluminense_Football_Club", "Madureira_Esporte_Clube", "Nova_Iguaçu_Futebol_Clube", "Club_de_Regatas_Vasco_da_Gama", "Volta_Redonda_Futebol_Clube", "Associação_Atlética_Portuguesa_(Rio_de_Janeiro)", "Audax_Rio_de_Janeiro_Esporte_Clube", "Sampaio_Corrêa_Futebol_e_Esporte"]
                    },
                    "mineiro": { 
                        id: "bra.camp.mineiro", apiFootballId: null, seasonId: 2026, name: "Campeonato Mineiro", 
                        logo: "https://a.espncdn.com/i/leaguelogos/soccer/500/2360.png", 
                        bg: "https://s2-ge.glbimg.com/jDlPK0oNRm7JAib8jk8Y0Yt0YjU=/0x0:2048x1365/984x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_bc8228b6673f488aa253bbcb03c80ec5/internal_photos/bs/2022/Y/m/5ERG4iS62kBaYhB5XL2A/51181088676-973df72e83-k-cris-mattos-fmf.jpg",
                        clubs: ["Clube_Atlético_Mineiro", "América_Futebol_Clube_(Minas_Gerais)", "Cruzeiro_Esporte_Clube", "Athletic_Club_(Minas_Gerais)", "Associação_Atlética_Caldense", "Democrata_Futebol_Clube", "Ipatinga_Futebol_Clube", "Patrocinense", "Pouso_Alegre_Futebol_Clube", "Tombense_Futebol_Clube", "Uberlândia_Esporte_Clube", "Villa_Nova_Atlético_Clube"]
                    },
                    "gaucho": { 
                        id: "bra.camp.gaucho", apiFootballId: null, seasonId: 2026, name: "Gauchão", 
                        logo: "https://upload.wikimedia.org/wikipedia/pt/7/7e/Gauch%C3%A3o_2025.png", 
                        bg: "https://s2-ge.glbimg.com/yK2ZKxnnDVvc50YxV6V68wGDE1E=/0x0:1280x960/1008x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_bc8228b6673f488aa253bbcb03c80ec5/internal_photos/bs/2021/9/L/lTsAFbTB6bmMB064vLpw/whatsapp-image-2021-03-24-at-11.57.47-1-.jpeg",
                        clubs: ["Grêmio_Foot-Ball_Porto_Alegrense", "Sport_Club_Internacional", "Esporte_Clube_Juventude", "Caxias_do_Sul", "Brasil_de_Pelotas", "Esporte_Clube_São_José", "Ypiranga_Futebol_Clube_(Erechim)", "Guarany_Futebol_Clube", "Esporte_Clube_Novo_Hamburgo", "Avenida", "Santa_Cruz_Futebol_Clube_(Santa_Cruz_do_Sul)", "Esporte_Clube_São_Luiz", "Monsoon_Futebol_Clube", "Esporte_Clube_Internacional_(Santa_Maria)"],
                        logoOverrides: {
                            "Guarany de Bagé": "https://www.ogol.com.br/img/logos/equipas/3280_imgbank_1688482671.png",
                            "Monsoon": "https://upload.wikimedia.org/wikipedia/commons/0/09/Monsoon_Futebol_Clube_logo.png",
                            "Internacional de Santa Maria": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Escudo_do_Inter_de_Santa_Maria.svg/1280px-Escudo_do_Inter_de_Santa_Maria.svg.png"
                        }
                    }
                }
            },
            "formula1": {
                name: "Fórmula 1",
                logo: "https://logos-world.net/wp-content/uploads/2023/12/F1-Logo.png",
                theme: "theme-f1",
                bg: "https://a1.espncdn.com/combiner/i?img=%2Fphoto%2F2020%2F0512%2Fr697825_1296x729_16%2D9.jpg",
                views: [
                    { id: 'schedule', name: 'Calendário', icon: 'calendar-days' },
                    { id: 'driver-standings', name: 'Mundial de Pilotos', icon: 'trophy' },
                    { id: 'team-standings', name: 'Mundial de Construtores', icon: 'shield' },
                    { id: 'historic-pilots', name: 'Pilotos Históricos', icon: 'user-square' },
                ],
                historicPilots: [
                    "Ayrton_Senna", "Michael_Schumacher", "Lewis_Hamilton", 
                    "Juan_Manuel_Fangio", "Alain_Prost", "Niki_Lauda", 
                    "Jackie_Stewart", "Jim_Clark", "Sebastian_Vettel", "Nelson_Piquet"
                ],
                leagues: { // Not really leagues, but can be used for years or other categorizations if needed
                }
            }
        };

        const API_CONFIG = {
            ESPN_BASE_SITE: 'https://site.api.espn.com/apis/site/v2/sports',
            ESPN_BASE_WEB: 'https://site.web.api.espn.com/apis',
            APIFOOTBALL_BASE_URL: 'https://v3.football.api-sports.io',
            // NOVO: Endpoint para transmissões baseado no exemplo do usuário.
            ESPORTESEMBED_BASE_URL: 'https://esportesembed.top',
            // FALLBACK: Endpoint do provedor anterior para maior robustez.
            REIDOSCANAIS_BASE_URL: 'https://api.reidoscanais.io',
            OPENF1_BASE_URL: 'https://api.openf1.org/v1',
            getScoreboardUrl: (s, l, d) => `${API_CONFIG.ESPN_BASE_SITE}/${s}/${l}/scoreboard?lang=pt&region=br&dates=${d}&limit=100`,
            getStandingsUrl: (l) => `${API_CONFIG.ESPN_BASE_WEB}/v2/sports/soccer/${l}/standings?lang=pt`,
            getGameSummaryUrl: (l, e) => `${API_CONFIG.ESPN_BASE_SITE}/soccer/${l}/summary?event=${e}&lang=pt`,
            getTeamScheduleUrl: (s, l, t) => `${API_CONFIG.ESPN_BASE_SITE}/${s}/${l}/teams/${t}/schedule?lang=pt&region=br`,
            getNewsUrl: (s, l) => `${API_CONFIG.ESPN_BASE_SITE}/${s}/${l}/news?lang=pt&region=br`,
            getTeamsUrl: (s, l) => `${API_CONFIG.ESPN_BASE_SITE}/${s}/${l}/teams?lang=pt&region=br`,
            getTeamRosterUrl: (l, t) => `${API_CONFIG.ESPN_BASE_SITE}/soccer/${l}/teams/${t}/roster?lang=pt`,
            getApiFootballScorersUrl: (leagueId, season) => `${API_CONFIG.APIFOOTBALL_BASE_URL}/players/topscorers?league=${leagueId}&season=${season}`,
            // NOVO: Gera a URL de embed diretamente.
            getEsportesEmbedUrl: (slug) => `${API_CONFIG.ESPORTESEMBED_BASE_URL}/${slug}`,
            // FALLBACK: URL de partida do provedor anterior.
            getReiDosCanaisMatchUrl: (slug) => `${API_CONFIG.REIDOSCANAIS_BASE_URL}/sports/${slug}`,
            getWikiSearchUrl: (q) => `https://pt.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(q)}&format=json&origin=*`,
            getWikiDetailUrl: (t) => `https://pt.wikipedia.org/w/api.php?action=query&prop=extracts|pageimages&exintro&explaintext&pithumbsize=500&titles=${encodeURIComponent(t)}&format=json&origin=*`,
            // F1 OpenF1
            getF1MeetingsUrl: (year) => `${API_CONFIG.OPENF1_BASE_URL}/meetings?year=${year}`,
            getF1DriverStandingsUrl: (session_key) => `${API_CONFIG.OPENF1_BASE_URL}/championship_drivers?session_key=${session_key}`,
            getF1TeamStandingsUrl: (session_key) => `${API_CONFIG.OPENF1_BASE_URL}/championship_teams?session_key=${session_key}`,
            // F1 ESPN Scoreboard (Results) - Atualizado conforme solicitação.
            // Este endpoint não parece suportar o parâmetro 'year' diretamente.
            getF1ScoreboardUrl: () => `${API_CONFIG.ESPN_BASE_SITE}/racing/f1/scoreboard?lang=pt`,
            getF1RaceSummaryUrl: (e) => `${API_CONFIG.ESPN_BASE_SITE}/racing/f1/summary?event=${e}&lang=pt`,
            formatDate: (date) => date.toISOString().slice(0, 10).replace(/-/g, "")
        };

        const app = {
            formations: {
                '4-3-3': [ { t: 90, l: 50 }, { t: 75, l: 85 }, { t: 78, l: 60 }, { t: 78, l: 40 }, { t: 75, l: 15 }, { t: 55, l: 50 }, { t: 45, l: 70 }, { t: 45, l: 30 }, { t: 20, l: 80 }, { t: 25, l: 50 }, { t: 20, l: 20 } ],
                '4-4-2': [ { t: 90, l: 50 }, { t: 75, l: 85 }, { t: 78, l: 60 }, { t: 78, l: 40 }, { t: 75, l: 15 }, { t: 50, l: 80 }, { t: 55, l: 60 }, { t: 55, l: 40 }, { t: 50, l: 20 }, { t: 20, l: 60 }, { t: 20, l: 40 } ],
                '3-5-2': [ { t: 90, l: 50 }, { t: 78, l: 75 }, { t: 80, l: 50 }, { t: 78, l: 25 }, { t: 50, l: 85 }, { t: 55, l: 60 }, { t: 55, l: 40 }, { t: 50, l: 15 }, { t: 35, l: 50 }, { t: 20, l: 65 }, { t: 20, l: 35 } ],
                '4-2-3-1': [ { t: 90, l: 50 }, { t: 75, l: 85 }, { t: 78, l: 60 }, { t: 78, l: 40 }, { t: 75, l: 15 }, { t: 60, l: 65 }, { t: 60, l: 35 }, { t: 35, l: 80 }, { t: 35, l: 50 }, { t: 35, l: 20 }, { t: 15, l: 50 } ],
                'default': [ { t: 90, l: 50 }, { t: 75, l: 15 }, { t: 75, l: 40 }, { t: 75, l: 60 }, { t: 75, l: 85 }, { t: 50, l: 25 }, { t: 50, l: 50 }, { t: 50, l: 75 }, { t: 25, l: 20 }, { t: 25, l: 50 }, { t: 25, l: 80 } ]
            },

            triggerStartOfGameAnimation(eventId) {
                const elSogOverlay = document.getElementById(`sog-overlay-${eventId}`);
                if (!elSogOverlay) return;
                
                elSogOverlay.classList.remove('active');
                setTimeout(() => elSogOverlay.classList.add('active'), 50);

                setTimeout(() => { elSogOverlay.classList.remove('active'); }, 4000);
            },

            state: { currentSport: 'soccer', currentLeague: 'brasileirao', currentDate: new Date(), view: 'matches', selectedSeason: 2026, currentMatchData: null, theme: 'dark', espnTeamsCache: {}, f1ScoreboardCache: {}, scorersCache: {}, playerDatabaseCache: null, matchTimerInterval: null, matchCardTimers: [], liveUpdateInterval: null, goalIntervals: {} },

            init() {
                try {
                    this.initTheme();
                    this.initPersona(); // Initialize persona
                    this.renderSportsNav();
                    this.renderPrimaryNavigation();
                    this.renderSeasonSelector();
                    this.setupEvents();
                    this.loadDataForView();
                    setTimeout(() => document.getElementById('global-loader').classList.add('loader-hidden'), 800);
                } catch(e) { console.error("W3Labs Init Error:", e); }
            },

            initTheme() {
                const savedTheme = localStorage.getItem('sporting_theme');
                if (savedTheme) {
                    this.setTheme(savedTheme);
                } else {
                    this.setTheme('dark'); 
                }
            },

            initPersona() {
                const savedPersona = localStorage.getItem('sporting_persona');
                if (savedPersona) {
                    this.setPersona(savedPersona);
                } else {
                    this.setPersona('adult'); // Default persona
                }
            },

            setPersona(persona) {
                this.state.currentPersona = persona;
                document.body.classList.remove('persona-young', 'persona-adult', 'persona-elderly');
                document.body.classList.add(`persona-${persona}`);
                document.getElementById('header-persona-name').innerText = persona.charAt(0).toUpperCase() + persona.slice(1); // Update header text
                localStorage.setItem('sporting_persona', persona);
                if(window.lucide) window.lucide.createIcons(); // Re-render icons if their color changes
            },

            toggleTheme() {
                const newTheme = this.state.theme === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
            },

            setTheme(theme) {
                this.state.theme = theme;
                const body = document.body;
                const moon = document.getElementById('theme-icon-moon');
                const sun = document.getElementById('theme-icon-sun');
                const flatpickrTheme = document.getElementById('flatpickr-theme');

                if (theme === 'light') {
                    body.classList.add('light-mode');
                    moon.classList.remove('hidden');
                    sun.classList.add('hidden');
                    if (flatpickrTheme) flatpickrTheme.href = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/light.css';
                } else {
                    body.classList.remove('light-mode');
                    moon.classList.add('hidden');
                    sun.classList.remove('hidden');
                    if (flatpickrTheme) flatpickrTheme.href = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css';
                }
                localStorage.setItem('sporting_theme', theme);
                if(window.lucide) window.lucide.createIcons();
            },
 
            async getEspnLeagueTeams(leagueId) {
                if (this.state.espnTeamsCache[leagueId]) {
                    return this.state.espnTeamsCache[leagueId];
                }
                try {
                    const res = await fetch(API_CONFIG.getTeamsUrl('soccer', leagueId));
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    const data = await res.json();
                    const teams = data.sports?.[0]?.leagues?.[0]?.teams?.map(t => t.team) || [];
                    this.state.espnTeamsCache[leagueId] = teams;
                    return teams;
                } catch (e) {
                    console.error("Error fetching ESPN teams:", e);
                    return [];
                }
            },

            setupEvents() {
                if(typeof flatpickr !== 'undefined') {
                    flatpickr("#date-picker", { defaultDate: "today", dateFormat: "d/m/Y", locale: "pt", onChange: (selectedDates) => { this.state.currentDate = selectedDates[0]; if(this.state.view === 'matches') this.loadDataForView(); } });
                }
                const seasonSelector = document.getElementById('season-selector');
                if (seasonSelector) { seasonSelector.addEventListener('change', (e) => { this.state.selectedSeason = e.target.value; if(this.state.view === 'scorers') this.fetchScorers(this.state.currentLeague); }); }
                
                const gsi = document.getElementById('global-search-input');
                if (gsi) {
                    gsi.addEventListener('input', (e) => this.handleGlobalSearch(e.target.value));
                    gsi.addEventListener('focus', (e) => {
                        if (e.target.value.length > 1) { document.getElementById('global-search-results').classList.remove('hidden'); }
                    });
                    document.addEventListener('click', (e) => {
                        const searchContainer = gsi.parentElement;
                        if (searchContainer && !searchContainer.contains(e.target)) {
                            document.getElementById('global-search-results').classList.add('hidden');
                        }
                    });
                }
                document.getElementById('wiki-search-input')?.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.searchWiki(); });
                document.getElementById('wiki-pilot-search-input')?.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.searchWiki(); });
            },

            renderSeasonSelector() {
                const sel = document.getElementById('season-selector');
                if (!sel) return;
                sel.innerHTML = '';
                // CORREÇÃO: Removido 'className = 'text-black'' que causava problemas de legibilidade no modo escuro.
                for(let i=0;i<5;i++) { const opt = document.createElement('option'); opt.value = 2026-i; opt.innerText = 2026-i; sel.appendChild(opt); }
            },

            loadPlayerDatabase() {
                // A base de dados de jogadores agora é carregada de uma variável interna.
                if (this.state.playerDatabaseCache) {
                    return this.state.playerDatabaseCache;
                }
                this.state.playerDatabaseCache = PLAYER_DB_DATA;
                return this.state.playerDatabaseCache;
            },

            async handleGlobalSearch(query) {
                const resultsContainer = document.getElementById('global-search-results');
                if (!query || query.length < 2) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    return;
                }

                resultsContainer.classList.remove('hidden');
                resultsContainer.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">Buscando...</div>';

                const sportKey = this.state.currentSport;
                let results = [];
                const lowerQuery = query.toLowerCase();

                if (sportKey === 'soccer') {
                    // Busca robusta de jogadores a partir da base de dados externa
                    const playerDB = this.loadPlayerDatabase();
                    if (playerDB.soccer) {
                        Object.keys(playerDB.soccer).forEach(leagueKey => {
                            // CORREÇÃO: A chave no playerDB (ex: 'bra.1') pode não ser a mesma chave do objeto de ligas (ex: 'brasileirao').
                            // A busca agora encontra a liga correspondente pelo ID ou pela chave.
                            const league = SPORTS_DB.soccer.leagues[leagueKey] || Object.values(SPORTS_DB.soccer.leagues).find(l => l.id === leagueKey);
                            if (league) { // Apenas continua se uma liga correspondente for encontrada
                                const players = playerDB.soccer[leagueKey] || [];
                                players.forEach(player => {
                                    const playerName = player.name || '';
                                    const commonName = player.commonName || '';
                                    if (playerName.toLowerCase().includes(lowerQuery) || commonName.toLowerCase().includes(lowerQuery)) {
                                        // Evita adicionar jogadores duplicados na lista de resultados
                                        if (!results.some(r => r.type === 'player' && r.name === playerName)) {
                                            results.push({
                                                type: 'player',
                                                name: playerName,
                                                subtitle: `Jogador • ${league.name}`,
                                                icon: 'user',
                                                action: () => this.loadWikiDetail(playerName)
                                            });
                                        }
                                    }
                                });
                            }
                        });
                    }

                    // Busca de clubes na liga atual (lógica existente)
                    const leagueKey = this.state.currentLeague;
                    const league = SPORTS_DB.soccer.leagues[leagueKey];
                    const espnTeams = await this.getEspnLeagueTeams(league.id);

                    espnTeams.forEach(team => {
                        const displayName = team.displayName;
                        if (displayName.toLowerCase().includes(lowerQuery)) {
                            const logoUrl = team.logos?.[0]?.href;
                            const clubWikiName = league.clubs.find(c => c.replace(/_/g, ' ').toLowerCase() === team.name.toLowerCase()) || team.name.replace(/ /g, '_');
                            results.push({ type: 'club', name: displayName, subtitle: league.name, logo: logoUrl,
                                action: () => { this.showTeamSchedule(team.id, team.displayName, logoUrl, clubWikiName); }
                            });
                        }
                    });
                } else if (sportKey === 'formula1') {
                    const pilots = SPORTS_DB.formula1.historicPilots || [];
                    pilots.forEach(pilotName => {
                        const displayName = pilotName.replace(/_/g, ' ');
                        if (displayName.toLowerCase().includes(lowerQuery)) {
                            results.push({ type: 'pilot', name: displayName, subtitle: 'Piloto Histórico', icon: 'user-square',
                                action: () => { this.setView('historic-pilots'); this.loadWikiDetail(pilotName); }
                            });
                        }
                    });
                }

                // Ordena os resultados para mostrar jogadores primeiro, depois clubes/pilotos
                results.sort((a, b) => {
                    if (a.type === 'player' && b.type !== 'player') return -1;
                    if (a.type !== 'player' && b.type === 'player') return 1;
                    return a.name.localeCompare(b.name);
                });

                this.renderGlobalSearchResults(results);
            },

            renderGlobalSearchResults(results) {
                const resultsContainer = document.getElementById('global-search-results');
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">Nenhum resultado encontrado.</div>';
                    return;
                }
                resultsContainer.innerHTML = '';
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    const iconHtml = result.logo ? `<img src="${result.logo}" alt="${result.name}">` : (result.icon ? `<i data-lucide="${result.icon}" class="w-8 h-8 text-gray-400"></i>` : '');
                    item.innerHTML = `${iconHtml}<div class="result-text"><div class="title">${result.name}</div><div class="subtitle">${result.subtitle}</div></div>`;
                    item.onclick = () => { result.action(); resultsContainer.classList.add('hidden'); document.getElementById('global-search-input').value = ''; };
                    resultsContainer.appendChild(item);
                });
                if(window.lucide) lucide.createIcons();
            },

            renderSportsNav() {
                const menu = document.getElementById('sport-menu');
                if (!menu) return;
                menu.innerHTML = '';
                Object.entries(SPORTS_DB).forEach(([key, sport]) => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2 text-white'; // Usar var(--text-primary)
                    item.innerHTML = `<img src="${sport.logo}" class="w-6 h-6 object-contain" onerror="this.style.display='none'"> ${sport.name}`;
                    item.onclick = () => this.changeSport(key);
                    menu.appendChild(item);
                });
            },

            renderPrimaryNavigation() {
                const sport = SPORTS_DB[this.state.currentSport];
                const leagueSelectorBtn = document.getElementById('league-selector-btn');
                const sidebarLeagues = document.getElementById('sidebar-league-list').parentElement;
                const navCard = document.querySelector('.nav-card');
                const bottomNav = document.querySelector('.bottom-nav');

                document.getElementById('header-sport-name').innerText = sport.name;

                // Update main navigation (sidebar and bottom nav)
                navCard.innerHTML = sport.views.map(v => 
                    `<button onclick="app.setView('${v.id}')" class="nav-btn" id="desk-nav-${v.id}"><i data-lucide="${v.icon}"></i> ${v.name}</button>`
                ).join('');
                bottomNav.innerHTML = sport.views.map(v => 
                    `<button class="bottom-nav-item" onclick="app.setView('${v.id}')" id="mob-nav-${v.id}"><i data-lucide="${v.icon}"></i><span>${v.name.split(' ')[0]}</span></button>`
                ).join('');

                if (this.state.currentSport === 'soccer') {
                    leagueSelectorBtn.style.display = 'flex';
                    sidebarLeagues.style.display = 'block';
                    this.renderLeagueNav();
                } else {
                    leagueSelectorBtn.style.display = 'none';
                    sidebarLeagues.style.display = 'none';
                }
                
                this.updateActiveNav(this.state.view);
                if(window.lucide) lucide.createIcons();
            },

            renderLeagueNav() {
                const menu = document.getElementById('league-menu');
                const sidebar = document.getElementById('sidebar-league-list');
                const mobList = document.getElementById('mob-league-list');
                if (menu) menu.innerHTML = ''; if (sidebar) sidebar.innerHTML = ''; if (mobList) mobList.innerHTML = '';

                Object.entries(SPORTS_DB.soccer.leagues).forEach(([key, league]) => {
                    if (menu) { const item = document.createElement('div'); item.className = 'dropdown-item p-2 hover:bg-white/10 rounded cursor-pointer flex items-center gap-2 text-white'; item.innerHTML = `<img src="${league.logo}" class="w-6 h-6 object-contain" onerror="this.style.display='none'"> ${league.name}`; item.onclick = () => this.changeSoccerLeague(key); menu.appendChild(item); }
                    if (sidebar) { const sideItem = document.createElement('button'); sideItem.className = 'w-full text-left p-2 px-3 rounded-xl hover:bg-white/10 flex items-center gap-3 text-sm text-gray-400 hover:text-white transition group'; sideItem.innerHTML = `<img src="${league.logo}" class="w-6 h-6 object-contain group-hover:scale-110 transition" onerror="this.style.display='none'"> <span class="font-medium" style="font-family: var(--font-family-primary);">${league.name}</span>`; sideItem.onclick = () => this.changeSoccerLeague(key); sidebar.appendChild(sideItem); }
                    if (mobList) { const mobItem = document.createElement('button'); mobItem.className = 'flex items-center gap-4 p-4 rounded-2xl bg-white/5 border border-white/10 w-full text-left hover:bg-white/10 transition'; mobItem.innerHTML = `<img src="${league.logo}" class="w-8 h-8 object-contain" onerror="this.style.display='none'"> <span class="text-white font-bold text-lg">${league.name}</span>`; mobItem.onclick = () => { this.changeSoccerLeague(key); this.toggleMobileLeague(); }; mobList.appendChild(mobItem); }
                });
            },

            changeSport(sportKey) {
                if (this.state.currentSport === sportKey) return;
                this.state.currentSport = sportKey;
                
                const sport = SPORTS_DB[sportKey];
                this.state.view = sport.views[0].id;
                if (sportKey === 'soccer') {
                    this.state.currentLeague = 'brasileirao';
                } else {
                    this.state.currentLeague = null;
                }

                this.renderPrimaryNavigation();
                this.loadDataForView();
            },

            changeSoccerLeague(key) { this.state.currentLeague = key; this.loadDataForView(); },

            async loadDataForView() {
                const sportKey = this.state.currentSport;
                const view = this.state.view;
                const sport = SPORTS_DB[sportKey];
                const leagueKey = this.state.currentLeague;

                const setText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };
                const setSrc = (id, src) => { const el = document.getElementById(id); if(el) el.src = src; };

                if (sportKey === 'soccer') {
                    const league = sport.leagues[leagueKey];
                    const dateStr = API_CONFIG.formatDate(this.state.currentDate);
                    
                    setText('header-league-name', league.name);
                    setSrc('header-league-logo', league.logo);
                    setSrc('mob-league-logo', league.logo);
                    setText('page-league-name', league.name);
                    setSrc('page-league-logo', league.logo); // Usar var(--card-border-radius)
                    setText('page-league-country', "Temporada " + this.state.selectedSeason);

                    const bgEl = document.getElementById('app-background');
                    if (bgEl) { bgEl.style.backgroundImage = `url('${league.bg}')`; }

                    if(view === 'matches') await this.fetchMatches(league.id, dateStr);
                    if(view === 'standings') await this.fetchStandings(league.id);
                    if(view === 'scorers') await this.fetchScorers(leagueKey);
                    if(view === 'news') await this.fetchNews(league.id);
                    if(view === 'clubs') this.renderClubs(leagueKey);
                    // A view 'team-schedule' é tratada por sua própria função de renderização
                } else if (sportKey === 'formula1') {
                    setText('page-league-name', sport.name);
                    setSrc('page-league-logo', sport.logo);
                    // MELHORIA: Usa um subtítulo genérico para F1 em vez de uma temporada hardcoded.
                    setText('page-league-country', "Campeonato Mundial");

                    const bgEl = document.getElementById('app-background');
                    if (bgEl) { bgEl.style.backgroundImage = `url('${sport.bg}')`; }
                    const feed = document.querySelector('.feed');
                    if (feed) feed.className = `feed ${sport.theme}`;

                    if(view === 'schedule') await this.fetchF1Schedule();
                    if(view === 'driver-standings') await this.fetchF1DriverStandings();
                    if(view === 'team-standings') await this.fetchF1TeamStandings(); // Corrected typo
                    if(view === 'historic-pilots') this.renderHistoricPilots();
                }
            },

            async fetchMatches(id, date) {
                const grid = document.getElementById('matches-grid'); if(!grid) return;
                grid.innerHTML = '<div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>';
                
                // Limpa o intervalo de atualização ao vivo existente antes de uma nova busca completa
                if (this.state.liveUpdateInterval) {
                    clearInterval(this.state.liveUpdateInterval);
                    this.state.liveUpdateInterval = null;
                }

                try {
                    const res = await fetch(API_CONFIG.getScoreboardUrl('soccer', id, date));
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    
                    // Limpa os cronômetros dos cards existentes antes de renderizar novos
                    this.state.matchCardTimers.forEach(clearInterval);
                    this.state.matchCardTimers = [];

                    const data = await res.json();
                    this.renderMatches(data.events || []);

                    if (data.events && data.events.some(e => e.status.type.state === 'in')) {
                        this.state.liveUpdateInterval = setInterval(() => this.updateLiveMatches(), 15000); // Atualiza a cada 15 segundos
                    }
                } catch (e) { console.error("Erro ao carregar partidas:", e); grid.innerHTML = '<div class="text-center text-red-400 col-span-full">Erro ao carregar partidas.</div>'; }
            },

            renderMatches(events) {
                const grid = document.getElementById('matches-grid'); if(!grid) return; grid.innerHTML = '';
                if(!events.length) { grid.innerHTML = '<div class="text-center text-gray-500 col-span-full py-10 font-medium">Nenhum jogo programado para hoje.</div>'; return; }
                const lConfig = SPORTS_DB.soccer.leagues[this.state.currentLeague];
                const liveIndicator = document.getElementById('live-indicator');
                if(liveIndicator) liveIndicator.classList.toggle('hidden', !events.some(e => e.status.type.state === 'in'));

                events.forEach(ev => {
                    const comp = ev.competitions[0];
                    const home = comp.competitors.find(c => c.homeAway === 'home');
                    const away = comp.competitors.find(c => c.homeAway === 'away');
                    const status = ev.status?.type;
                    const displayClock = ev.status?.displayClock; 
                    const allEvents = comp.details || [];
                    const cardEventsCount = allEvents.filter(e => e.type === 'yellowcard' || e.type === 'redcard').length;
                    const subEventsCount = allEvents.filter(e => e.type === 'substitution').length;
                    const varEventsCount = allEvents.filter(e => e.text && (e.text.toLowerCase().includes('var') || e.text.toLowerCase().includes('revisão'))).length;

                    const card = document.createElement('div'); 
                    card.className = 'match-card'; 
                    card.setAttribute('data-event-id', ev.id);
                    card.setAttribute('data-home-score', home.score || '0');
                    card.setAttribute('data-away-score', away.score || '0');
                    card.setAttribute('data-status-state', status?.state || 'post');
                    card.setAttribute('data-card-events', cardEventsCount);
                    card.setAttribute('data-substitution-events', subEventsCount);
                    card.setAttribute('data-var-events', varEventsCount);
                    card.onclick = () => this.openMatch(ev.id);
                    
                    const leagueLogo = lConfig.logo;

                    const homeTeamColor = home.team.color ? `#${home.team.color}` : 'rgba(0,0,0,0.2)'; // Fallback se a cor não estiver disponível
                    const awayTeamColor = away.team.color ? `#${away.team.color}` : 'rgba(0,0,0,0.2)';

                    card.innerHTML = `
                        <div class="unified-broadcast-board" data-event-id="${ev.id}">
                            <div class="unified-main-bar">
                                <!-- Goal Overlay -->
                                <div id="goal-overlay-${ev.id}" class="unified-full-overlay" style="justify-content: flex-start;">
                                    <img id="goal-overlay-logo-${ev.id}" src="" alt="Team" class="unified-overlay-logo">
                                    <div class="unified-goal-content">
                                        <span class="unified-goal-text-g">G</span>
                                        <span id="goal-text-os-${ev.id}" class="unified-goal-text-os"></span>
                                        <span id="goal-text-l-${ev.id}" class="unified-goal-text-l" style="opacity: 0;">L!</span>
                                    </div>
                                </div>

                                <!-- Card Overlay -->
                                <div id="card-overlay-${ev.id}" class="unified-full-overlay">
                                    <img id="card-overlay-logo-${ev.id}" src="" alt="Team" class="unified-overlay-logo">
                                    <div class="unified-card-info-group">
                                        <div class="unified-card-text-group">
                                            <span id="card-overlay-label-${ev.id}" class="unified-card-label"></span>
                                            <span id="card-overlay-player-${ev.id}" class="unified-card-player-name"></span>
                                        </div>
                                        <img id="card-overlay-photo-${ev.id}" src="" alt="Player" class="unified-card-player-photo">
                                    </div>
                                </div>

                                <!-- Substitution Overlay -->
                                <div id="sub-overlay-${ev.id}" class="unified-full-overlay">
                                    <img id="sub-overlay-logo-${ev.id}" src="" alt="Team" class="unified-overlay-logo">
                                    <div class="sub-info-group">
                                        <div class="sub-player-group">
                                            <div class="sub-icon sub-icon-out"><i data-lucide="arrow-down" class="w-3 h-3"></i></div>
                                            <img id="sub-player-out-photo-${ev.id}" class="unified-card-player-photo !w-9 !h-9">
                                            <span id="sub-player-out-name-${ev.id}" class="unified-card-player-name !text-base"></span>
                                        </div>
                                        <div class="sub-player-group">
                                            <div class="sub-icon sub-icon-in"><i data-lucide="arrow-up" class="w-3 h-3"></i></div>
                                            <img id="sub-player-in-photo-${ev.id}" class="unified-card-player-photo !w-9 !h-9">
                                            <span id="sub-player-in-name-${ev.id}" class="unified-card-player-name !text-base"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- VAR Overlay -->
                                <div id="var-overlay-${ev.id}" class="unified-full-overlay" style="justify-content: center;">
                                    <div class="var-pattern"></div>
                                    <div class="var-content">
                                        <div id="var-title-${ev.id}" class="var-title">CHECANDO LANCE</div>
                                        <div id="var-subtitle-${ev.id}" class="var-subtitle">ÁRBITRO DE VÍDEO</div>
                                    </div>
                                </div>

                                <!-- Start of Game Overlay -->
                                <div id="sog-overlay-${ev.id}" class="unified-full-overlay" style="justify-content: center; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
                                    <div class="sog-content text-center">
                                        <div class="sog-title">BOLA ROLANDO</div>
                                        <div class="sog-subtitle">Início de Jogo</div>
                                    </div>
                                </div>

                                <!-- End of Game Overlay -->
                                <div id="eog-overlay-${ev.id}" class="unified-full-overlay" style="justify-content: center; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
                                    <div class="eog-content text-center">
                                        <div class="eog-title">APITO FINAL</div>
                                        <div class="eog-subtitle">Fim de Jogo</div>
                                    </div>
                                </div>

                                <!-- Main Scoreboard Content -->
                                <div class="unified-team-block left" style="background-color: ${homeTeamColor};">
                                    <img src="${home.team.logo || ''}" class="unified-team-logo mr-2" alt="${home.team.shortDisplayName}">
                                    <div class="unified-team-abbr">${home.team.abbreviation}</div>
                                </div>
                                <div class="unified-center-content" style="background: linear-gradient(to right, ${homeTeamColor} 0%, ${homeTeamColor} 50%, ${awayTeamColor} 50%, ${awayTeamColor} 100%);">
                                    <div class="unified-score-num" id="score-home-${ev.id}">${home.score || '0'}</div>
                                    <div class="unified-league-logo-area">
                                        <img src="${leagueLogo}" alt="${lConfig.name}">
                                    </div>
                                    <div class="unified-score-num" id="score-away-${ev.id}">${away.score || '0'}</div>
                                </div>
                                <div class="unified-team-block right" style="background-color: ${awayTeamColor};">
                                    <div class="unified-team-abbr" >${away.team.abbreviation}</div>
                                    <img src="${away.team.logo || ''}" class="unified-team-logo ml-2" alt="${away.team.shortDisplayName}">
                                </div>
                            </div>
                            <div class="unified-timer-pill" id="timer-pill-${ev.id}">
                                ${status?.state === 'in' 
                                    ? `<span>${displayClock || "00:00"}</span>` 
                                    : `<span>${status?.shortDetail || status?.description || 'Finalizado'}</span>`
                                }
                            </div>
                        </div>
                        <div class="match-footer"><span class="truncate w-1/2 font-bold" style="font-family: var(--font-family-primary);">${(ev.name || '').replace(/ em /gi, ' vs ')}</span><span class="truncate w-1/2 text-right text-xs opacity-70"><i data-lucide="map-pin" class="inline w-3 h-3"></i> ${comp.venue?.fullName||'Estádio'}</span></div>`;
                    grid.appendChild(card);
                    if (status.state === 'in') {
                        const timerId = this.startLiveCardTimer(ev.id, comp.status);
                        this.state.matchCardTimers.push(timerId);
                    }
                });
                if(window.lucide) window.lucide.createIcons();
            },

            async updateLiveMatches() {
                if (this.state.view !== 'matches' || this.state.currentSport !== 'soccer') return;

                const league = SPORTS_DB.soccer.leagues[this.state.currentLeague];
                const dateStr = API_CONFIG.formatDate(this.state.currentDate);

                try {
                    const res = await fetch(API_CONFIG.getScoreboardUrl('soccer', league.id, dateStr));
                    if (!res.ok) return;
                    const data = await res.json();
                    const events = data.events || [];

                    if (!events.some(e => e.status.type.state === 'in')) {
                        if (this.state.liveUpdateInterval) {
                            clearInterval(this.state.liveUpdateInterval);
                            this.state.liveUpdateInterval = null;
                        }
                        document.getElementById('live-indicator')?.classList.add('hidden');
                        // Atualiza o status final dos jogos que acabaram
                        events.forEach(ev => {
                            const timerPill = document.getElementById(`timer-pill-${ev.id}`);
                            if (timerPill) timerPill.innerHTML = `<span>${ev.status.type.shortDetail}</span>`;
                        });
                        return;
                    }

                    document.getElementById('live-indicator')?.classList.remove('hidden');

                    events.forEach(ev => {
                        const matchCard = document.querySelector(`.match-card[data-event-id='${ev.id}']`);
                        if (!matchCard) return;

                        const comp = ev.competitions[0];
                        const h = comp.competitors.find(c => c.homeAway === 'home');
                        const a = comp.competitors.find(c => c.homeAway === 'away');
                        const status = ev.status.type;

                        // 1. Checa Fim de Jogo e Início de Jogo
                        const oldStatusState = matchCard.getAttribute('data-status-state');
                        if (oldStatusState === 'in' && status.state === 'post') {
                            // CORREÇÃO: Chamando a função de animação de fim de jogo que estava faltando.
                            this.triggerEndOfGameAnimation(ev.id);
                        } else if (oldStatusState === 'pre' && status.state === 'in') {
                            this.triggerStartOfGameAnimation(ev.id);
                        }
                        matchCard.setAttribute('data-status-state', status.state);

                        // 2. Checa Gols (Placar)
                        const oldHomeScore = parseInt(matchCard.getAttribute('data-home-score')) || 0;
                        const oldAwayScore = parseInt(matchCard.getAttribute('data-away-score')) || 0;
                        const newHomeScore = parseInt(h.score || '0');
                        const newAwayScore = parseInt(a.score || '0');

                        if (newHomeScore > oldHomeScore) {
                            this.triggerGoalAnimation(ev.id, h);
                            document.getElementById(`score-home-${ev.id}`).innerText = newHomeScore;
                            matchCard.setAttribute('data-home-score', newHomeScore);
                        }
                        if (newAwayScore > oldAwayScore) {
                            this.triggerGoalAnimation(ev.id, a);
                            document.getElementById(`score-away-${ev.id}`).innerText = newAwayScore;
                            matchCard.setAttribute('data-away-score', newAwayScore);
                        }

                        // 3. Checa outros eventos (cartões, subs, VAR) apenas se o jogo estiver rolando
                        if (status.state === 'in' && comp.details) {
                            const allEvents = comp.details;

                            const oldCardCount = parseInt(matchCard.getAttribute('data-card-events')) || 0;
                            const cardEvents = allEvents.filter(e => e.type === 'yellowcard' || e.type === 'redcard');
                            if (cardEvents.length > oldCardCount) {
                                const lastNewCard = cardEvents[cardEvents.length - 1];
                                const team = h.team.id === lastNewCard.team.id ? h : a;
                                this.triggerCardAnimation(ev.id, lastNewCard, team);
                                matchCard.setAttribute('data-card-events', cardEvents.length);
                            }

                            const oldSubCount = parseInt(matchCard.getAttribute('data-substitution-events')) || 0;
                            const subEvents = allEvents.filter(e => e.type === 'substitution');
                            if (subEvents.length > oldSubCount) {
                                const lastNewSub = subEvents[subEvents.length - 1];
                                const team = h.team.id === lastNewSub.team.id ? h : a;
                                this.triggerSubstitutionAnimation(ev.id, lastNewSub, team);
                                matchCard.setAttribute('data-substitution-events', subEvents.length);
                            }

                            const oldVarCount = parseInt(matchCard.getAttribute('data-var-events')) || 0;
                            const varEvents = allEvents.filter(e => e.text && (e.text.toLowerCase().includes('var') || e.text.toLowerCase().includes('revisão')));
                            if (varEvents.length > oldVarCount) {
                                const lastNewVar = varEvents[varEvents.length - 1];
                                this.triggerVARAnimation(ev.id, lastNewVar);
                                matchCard.setAttribute('data-var-events', varEvents.length);
                            }
                        }

                        // 4. Garante que o cronômetro está rodando para jogos que acabaram de começar
                        const timerPill = document.getElementById(`timer-pill-${ev.id}`);
                        if (timerPill && status.state === 'in' && !timerPill.querySelector('.animate-pulse')) {
                            const timerId = this.startLiveCardTimer(ev.id, comp.status);
                            this.state.matchCardTimers.push(timerId);
                        } else if (timerPill && status.state !== 'in' && timerPill.querySelector('.animate-pulse')) {
                            // O jogo terminou, atualiza o status. O timer será limpo na próxima carga completa.
                            timerPill.innerHTML = `<span>${status.shortDetail}</span>`;
                        }
                    });

                } catch (e) {
                    console.error("Erro ao atualizar partidas ao vivo:", e);
                }
            },

            async fetchStandings(id) {
                const con = document.getElementById('standings-container'); if(!con) return;
                const legend = document.getElementById('standings-legend'); if(legend) legend.innerHTML = '';
                con.innerHTML = '<div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>';
                
                try {
                    const res = await fetch(API_CONFIG.getStandingsUrl(id));
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    con.innerHTML = '';
                    
                    // Determine zones based on League ID
                    let zones = {};
                    let legendItems = [];
                    
                    if (this.state.currentLeague === 'brasileirao') {
                        zones = { 1: 'libertadores', 2: 'libertadores', 3: 'libertadores', 4: 'libertadores', 5: 'prelibertadores', 6: 'prelibertadores', 7: 'sulamericana', 8: 'sulamericana', 9: 'sulamericana', 10: 'sulamericana', 11: 'sulamericana', 12: 'sulamericana', 17: 'rebaixamento', 18: 'rebaixamento', 19: 'rebaixamento', 20: 'rebaixamento' };
                        legendItems = [
                            { color: 'bg-libertadores', text: 'Libertadores' },
                            { color: 'bg-prelibertadores', text: 'Pré-Libertadores' },
                            { color: 'bg-sulamericana', text: 'Sul-Americana' },
                            { color: 'bg-rebaixamento', text: 'Rebaixamento' }
                        ];
                    } else if (this.state.currentLeague === 'brasileiraob') {
                        zones = { 1: 'acesso', 2: 'acesso', 3: 'acesso', 4: 'acesso', 17: 'rebaixamento', 18: 'rebaixamento', 19: 'rebaixamento', 20: 'rebaixamento' };
                        legendItems = [
                            { color: 'bg-acesso', text: 'Acesso à Série A' },
                            { color: 'bg-rebaixamento', text: 'Rebaixamento' }
                        ];
                    } else if (this.state.currentLeague === 'premier' || this.state.currentLeague === 'laliga' || this.state.currentLeague === 'seriea' || this.state.currentLeague === 'bundesliga') {
                         zones = { 1: 'libertadores', 2: 'libertadores', 3: 'libertadores', 4: 'libertadores', 5: 'sulamericana', 6: 'sulamericana', 18: 'rebaixamento', 19: 'rebaixamento', 20: 'rebaixamento' };
                         legendItems = [ { color: 'bg-libertadores', text: 'Champions League' }, { color: 'bg-sulamericana', text: 'Europa League' }, { color: 'bg-rebaixamento', text: 'Rebaixamento' } ];
                    }

                    if (legend) {
                        legend.innerHTML = legendItems.map(i => `<div class="legend-item"><div class="legend-dot ${i.color}"></div><span>${i.text}</span></div>`).join('');
                    }

                    (data.children||[]).forEach(g => {
                        const card = document.createElement('div'); card.className = 'glass-panel overflow-hidden mb-6';
                        let html = `<div class="p-5 border-b border-white/5 font-bold text-lg uppercase text-[var(--accent)] bg-white/5 tracking-wider">${g.name}</div>`;
                        html += `<div class="std-table-header"><div>#</div><div class="text-left">Clube</div><div class="text-center">Pts</div><div class="text-center">J</div><div class="text-center">V</div><div class="text-center">E</div><div class="text-center">D</div><div class="text-center">SG</div><div class="text-center">%</div></div>`;
                        (g.standings.entries||[]).forEach((e,i) => {
                            const val = n => e.stats.find(s=>s.name===n)?.value||0;
                            const rank = i + 1;
                            const zone = zones[rank] ? `zone-${zones[rank]}` : 'zone-neutra';
                            const bgZone = zones[rank] ? `bg-${zones[rank]}` : 'bg-neutra';
                            
                            html += `<div class="std-row">
                                <div class="rank-cell"><div class="rank-dot ${bgZone}"></div><span>${rank}</span></div>
                                <div class="team-cell"><img src="${e.team.logos?.[0]?.href}"> <span class="truncate">${e.team.shortDisplayName}</span></div>
                                <span class="font-bold text-center text-lg">${val('points')}</span>
                                <span class="opacity-70 text-center">${val('gamesPlayed')}</span>
                                <span class="opacity-70 text-center">${val('wins')}</span>
                                <span class="opacity-70 text-center">${val('ties')}</span>
                                <span class="opacity-70 text-center">${val('losses')}</span>
                                <span class="opacity-70 text-center">${val('pointDifferential')}</span>
                                <span class="opacity-70 text-center text-xs">${val('gamesPlayed') > 0 ? Math.round((val('points')/(val('gamesPlayed')*3))*100) : 0}%</span>
                            </div>`;
                        });
                        card.innerHTML = html; con.appendChild(card);
                    });
                } catch (e) { console.error("Erro ao buscar a tabela de classificação:", e); con.innerHTML = '<div class="text-center text-red-400">Erro ao carregar a tabela.</div>'; }
            },

            async fetchF1Schedule() {
                const grid = document.getElementById('schedule-grid'); if(!grid) return;
                grid.innerHTML = '<div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>';
                try {
                    // A API de placar da F1 da ESPN (não documentada) não parece aceitar um parâmetro de ano.
                    // Ela provavelmente retorna os dados mais recentes ou da temporada atual.
                    // A seleção de ano para o calendário da F1 pode não ter efeito com este endpoint.
                    const res = await fetch(API_CONFIG.getF1ScoreboardUrl());
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    this.renderF1Schedule(data.events || []);
                } catch (e) { console.error("Erro ao carregar calendário de F1:", e); grid.innerHTML = '<div class="text-center text-red-400 col-span-full">Erro ao carregar calendário.</div>'; }
            },

            renderF1Schedule(events) {
                const grid = document.getElementById('schedule-grid'); if(!grid) return; grid.innerHTML = '';
                if(!events.length) { grid.innerHTML = '<div class="text-center text-gray-500 col-span-full py-10 font-medium">Nenhuma corrida encontrada para esta temporada.</div>'; return; }
                
                events.forEach(event => {
                    const card = document.createElement('div'); 
                    card.className = 'f1-race-card cursor-pointer';
                    card.onclick = () => this.openF1Race(event);
                    
                    const comp = event.competitions[0];
                    const venue = comp.venue; // Usar var(--card-border-radius)
                    const status = event.status?.type;
                    const isCompleted = status.completed;
                    
                    const date = new Date(event.date);
                    const dateString = date.toLocaleDateString('pt-BR', {day:'2-digit', month:'short'});
                    const timeString = date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});

                    let resultsHtml = '';
                    if (isCompleted && comp.competitors && comp.competitors.length > 0) {
                        const podium = comp.competitors.filter(c => parseInt(c.order) <= 3 && parseInt(c.order) > 0).sort((a,b) => a.order - b.order);
                        resultsHtml = `<div class="mt-4 border-t border-white/10 pt-4 space-y-2">
                            ${podium.map(p => {
                                const teamColor = p.athlete.team?.color ? `#${p.athlete.team.color}` : 'var(--glass-border)';
                                return `
                                <div class="flex items-center text-sm gap-3">
                                    <span class="font-bold text-center w-6 text-base" style="color: var(--text-primary); font-family: var(--font-family-primary);">${p.order}</span>
                                    <div class="w-1 h-4 rounded-full" style="background-color: ${teamColor};"></div>
                                    <span class="font-medium truncate" style="color: var(--text-primary);">${p.athlete.displayName}</span>
                                    <span class="ml-auto text-xs font-mono text-gray-400">${p.records?.[0]?.displayValue || ''}</span>
                                </div>
                            `}).join('')}
                        </div>`;
                    } else {
                        resultsHtml = `<div class="mt-4 border-t border-white/10 pt-4 text-center text-sm text-gray-400">Aguardando resultados</div>`;
                    }

                    card.innerHTML = `
                        <div class="p-5">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-[var(--accent)] uppercase" style="font-family: var(--font-family-secondary);">${venue.fullName}</p>
                                    <h3 class="font-bold text-lg text-white">${event.shortName}</h3>
                                </div>
                                <div class="text-right shrink-0 ml-4">
                                    <p class="font-bold text-sm" style="color: var(--text-primary);">${dateString}</p>
                                    <p class="text-xs text-gray-400">${isCompleted ? (status?.description || 'Concluído') : timeString}</p>
                                </div>
                            </div>
                            ${resultsHtml}
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },

            async fetchF1DriverStandings() {
                const con = document.getElementById('driver-standings-container'); if(!con) return;
                con.innerHTML = '<div class="py-20 flex justify-center"><div class="loader-ring"></div></div>';
                try {
                    const standingsRes = await fetch(API_CONFIG.getF1DriverStandingsUrl('latest'));
                    const standingsData = await standingsRes.json();
                    if (!standingsData || standingsData.length === 0) {
                        con.innerHTML = '<div class="text-center text-gray-500 p-10">Campeonato de pilotos não disponível.</div>';
                        return;
                    }

                    const sessionKey = standingsData[0].session_key;
                    const driversRes = await fetch(`${API_CONFIG.OPENF1_BASE_URL}/drivers?session_key=${sessionKey}`);
                    const driversData = await driversRes.json();

                    const driversMap = new Map(driversData.map(d => [d.driver_number, d]));
                    this.renderF1DriverStandings(standingsData, driversMap);
                } catch (e) { console.error("Erro ao carregar campeonato de pilotos de F1:", e); con.innerHTML = '<div class="text-center text-red-400 p-10">Erro ao carregar campeonato de pilotos.</div>'; }
            },

            renderF1DriverStandings(standings, driversMap) {
                const con = document.getElementById('driver-standings-container'); if(!con) return;
                
                let html = `<div class="std-table-header" style="grid-template-columns: 50px minmax(180px, 2fr) minmax(150px, 2fr) 1fr;"><div>#</div><div class="text-left">Piloto</div><div class="text-left">Equipe</div><div class="text-center">Pts</div></div>`;
                
                // ERRO CORRIGIDO: A API usa 'position' e 'points', não 'position_current' ou 'points_current'.
                standings.sort((a, b) => a.position - b.position);

                standings.forEach(standing => {
                    const driverInfo = driversMap.get(standing.driver_number);
                    const driverName = driverInfo ? driverInfo.full_name : `Piloto #${standing.driver_number}`;
                    const teamName = driverInfo ? driverInfo.team_name : 'N/A';
                    const teamColour = driverInfo && driverInfo.team_colour ? `#${driverInfo.team_colour}` : 'var(--text-muted)';
                    
                    html += `<div class="std-row" style="grid-template-columns: 50px minmax(180px, 2fr) minmax(150px, 2fr) 1fr;">
                        <div class="rank-cell"><span style="font-family: var(--font-family-primary);">${standing.position || '-'}</span></div>
                        <div class="team-cell">
                            <span class="truncate font-bold" style="font-family: var(--font-family-primary);">${driverName}</span>
                        </div>
                        <div class="team-cell">
                            <div style="width: 4px; height: 20px; background-color: ${teamColour}; border-radius: 2px; margin-right: 8px;"></div>
                            <span class="truncate" style="font-family: var(--font-family-primary);">${teamName}</span>
                        </div>
                        <span class="font-bold text-center text-lg" style="font-family: var(--font-family-primary);">${standing.points || '0'}</span>
                    </div>`;
                });
                con.innerHTML = html;
            },

            async fetchF1TeamStandings() {
                const con = document.getElementById('team-standings-body'); if(!con) return;
                con.innerHTML = '<div class="py-20 flex justify-center"><div class="loader-ring"></div></div>';
                try {
                    const teamStandingsRes = await fetch(API_CONFIG.getF1TeamStandingsUrl('latest'));
                    const teamStandingsData = await teamStandingsRes.json();

                    if (!teamStandingsData || teamStandingsData.length === 0) {
                        con.innerHTML = '<div class="text-center text-gray-500 p-10">Campeonato de construtores não disponível.</div>';
                        return;
                    }

                    const sessionKey = teamStandingsData[0].session_key;
                    const driversRes = await fetch(`${API_CONFIG.OPENF1_BASE_URL}/drivers?session_key=${sessionKey}`);
                    const driversData = await driversRes.json();

                    const teamColourMap = new Map();
                    driversData.forEach(d => {
                        if (d.team_name && d.team_colour && !teamColourMap.has(d.team_name)) {
                            teamColourMap.set(d.team_name, d.team_colour);
                        }
                    });

                    this.renderF1TeamStandings(teamStandingsData, teamColourMap);
                } catch (e) { console.error("Erro ao carregar campeonato de construtores de F1:", e); con.innerHTML = '<div class="text-center text-red-400 p-10">Erro ao carregar campeonato de construtores.</div>'; }
            },

            renderF1TeamStandings(standings, teamColourMap) {
                const con = document.getElementById('team-standings-body'); if(!con) return;
                con.innerHTML = '';
                
                // ERRO CORRIGIDO: A API usa 'position' e 'points', não 'position_current' ou 'points_current'.
                standings.sort((a, b) => a.position - b.position);

                standings.forEach(standing => {
                    const teamColour = teamColourMap.get(standing.team_name) ? `#${teamColourMap.get(standing.team_name)}` : 'var(--text-muted)';
                    const row = document.createElement('div');
                    row.className = 'std-row';
                    row.style.gridTemplateColumns = '50px minmax(180px, 3fr) 1fr';
                    row.innerHTML = `
                        <div class="rank-cell"><span style="font-family: var(--font-family-primary);">${standing.position || '-'}</span></div>
                        <div class="team-cell">
                            <div style="width: 4px; height: 20px; background-color: ${teamColour}; border-radius: 2px; margin-right: 8px;"></div>
                            <span class="truncate font-bold" style="font-family: var(--font-family-primary);">${standing.team_name || 'Equipe N/D'}</span>
                        </div>
                        <span class="font-bold text-center text-lg" style="font-family: var(--font-family-primary);">${standing.points || '0'}</span>
                    `;
                    con.appendChild(row);
                });
            },

            async openF1Race(event) {
                const modal = document.getElementById('f1-race-modal');
                if (!modal) return;

                modal.classList.add('open');
                
                document.getElementById('f1-modal-racename').innerText = event.name;
                document.getElementById('f1-modal-circuit').innerText = event.competitions[0].venue.fullName;
                const startDate = new Date(event.date); // Usar var(--font-family-primary)
                document.getElementById('f1-modal-date').innerText = startDate.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('f1-modal-bg').style.backgroundImage = `url('${SPORTS_DB.formula1.bg}')`;

                const contentArea = document.getElementById('f1-modal-content');
                const tabsArea = document.getElementById('f1-modal-tabs');
                contentArea.innerHTML = '<div class="py-20 flex justify-center"><div class="loader-ring"></div></div>';
                tabsArea.innerHTML = '';

                try {
                    const summaryRes = await fetch(API_CONFIG.getF1RaceSummaryUrl(event.id));
                    const summaryData = await summaryRes.json();
                    
                    this.renderF1RaceDetails(summaryData);

                } catch (e) {
                    console.error("Erro ao buscar detalhes da corrida de F1:", e);
                    contentArea.innerHTML = `<div class="text-center text-red-400 p-10">${e.message || 'Não foi possível carregar os detalhes da corrida.'}</div>`;
                }
            },

            renderF1RaceDetails(data) {
                const contentArea = document.getElementById('f1-modal-content');
                const tabsArea = document.getElementById('f1-modal-tabs');
                contentArea.innerHTML = '';
                tabsArea.innerHTML = '';

                const tabs = data.tabs || [];
                const pickcenter = data.pickcenter || [];

                if (!tabs.length || !pickcenter.length) {
                    contentArea.innerHTML = '<div class="text-center text-gray-500 p-10">Resultados não disponíveis.</div>';
                    return;
                }

                tabs.forEach((tab, index) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'px-4 py-3 text-sm font-bold border-b-2 transition whitespace-nowrap text-gray-400 border-transparent hover:text-white';
                    tabButton.innerText = tab.displayName;
                    
                    const contentId = `f1-tab-content-${tab.id}`; // Usar var(--font-family-primary)
                    tabButton.onclick = () => {
                        tabsArea.querySelectorAll('button').forEach(btn => btn.className = 'px-4 py-3 text-sm font-bold border-b-2 transition whitespace-nowrap text-gray-400 border-transparent hover:text-white');
                        document.querySelectorAll('.f1-tab-pane').forEach(pane => pane.classList.add('hidden'));
                        tabButton.className = 'px-4 py-3 text-sm font-bold border-b-2 transition whitespace-nowrap text-white border-[var(--accent)]';
                        document.getElementById(contentId).classList.remove('hidden');
                    };
                    tabsArea.appendChild(tabButton);

                    const tabContent = document.createElement('div');
                    tabContent.id = contentId;
                    tabContent.className = 'f1-tab-pane hidden';

                    const providerData = pickcenter.find(p => p.provider === tab.id);
                    if (providerData && providerData.tables) {
                        (providerData.tables || []).forEach(tableData => {
                            const headers = tableData.headers || []; // Usar var(--font-family-primary)
                            const gridCols = `50px repeat(${headers.length > 0 ? headers.length - 1 : 0}, minmax(0, 1fr))`;
                            let tableHtml = `<div class="std-table-container mb-8"><div class="p-4 font-bold text-lg bg-white/5">${tableData.displayName || 'Resultados'}</div><div class="std-table-header" style="grid-template-columns: ${gridCols};">${headers.map(h => `<div>${h || ''}</div>`).join('')}</div>`;
                            (tableData.rows || []).forEach(row => { 
                                tableHtml += `<div class="std-row" style="grid-template-columns: ${gridCols};">${(row.cells || []).map((c, i) => `<div class="${i === 0 ? 'font-bold text-lg' : 'opacity-80'}">${c || '-'}</div>`).join('')}</div>`; });
                            tabContent.innerHTML += tableHtml + '</div>';
                        });
                    } else { tabContent.innerHTML = '<div class="text-center text-gray-500 p-10">Dados não disponíveis para esta sessão.</div>'; }
                    contentArea.appendChild(tabContent);
                    if (index === 0) { tabButton.click(); }
                });
            },

            closeF1Modal() { document.getElementById('f1-race-modal').classList.remove('open'); },

            async fetchScorers(leagueKey) {
                const g = document.getElementById('scorers-grid'); if (!g) return;
                g.innerHTML = '<div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>';
                const leagueData = SPORTS_DB.soccer.leagues[leagueKey];
                if (!leagueData || !leagueData.apiFootballId) { g.innerHTML = '<div class="col-span-full text-center text-gray-500 glass-panel p-10">Dados indisponíveis.</div>'; return; }
                
                const season = this.state.selectedSeason;
                const cacheKey = `${leagueKey}_${season}`;

                const renderScorers = async (scorersData) => {
                    if (!scorersData || scorersData.length === 0) {
                        g.innerHTML = '<div class="col-span-full text-center text-gray-500 glass-panel p-10">Sem dados de artilharia para esta temporada.</div>';
                        return;
                    }
                    const espnTeams = await this.getEspnLeagueTeams(leagueData.id);
                    g.innerHTML = '';
                    scorersData.slice(0, 20).forEach((item, i) => {
                        const p = item.player; 
                        const s = item.statistics[0];
                        const teamNameLower = s.team.name.toLowerCase();
                        const teamData = espnTeams.find(t => t.name.toLowerCase() === teamNameLower || t.displayName.toLowerCase() === teamNameLower);
                        const teamLogo = teamData?.logos?.[0]?.href;
                        const teamLogoImg = teamLogo ? `<img src="${teamLogo}" class="w-5 h-5 mr-2 object-contain">` : '';

                        const card = document.createElement('div');
                        card.className = 'scorer-card cursor-pointer';
                    card.onclick = () => this.loadWikiDetail(p.name, p.photo); // Usar var(--font-family-primary)
                        card.innerHTML = `<div class="scorer-rank text-[var(--accent)]">${i+1}</div><img src="${p.photo}" class="scorer-img"><div class="flex-1"><div class="font-bold text-lg" style="color: var(--text-primary)">${p.name}</div><div class="text-sm font-medium flex items-center" style="color: var(--text-muted)">${teamLogoImg}<span>${s.team.name}</span></div></div><div class="scorer-goals">${s.goals.total}</div>`;
                        g.appendChild(card);
                    });
                };

                if (this.state.scorersCache[cacheKey]) {
                    renderScorers(this.state.scorersCache[cacheKey]);
                    return;
                }
                
                try {
                    const res = await fetch(API_CONFIG.getApiFootballScorersUrl(leagueData.apiFootballId, season), { headers: { 'x-apisports-key': APIFOOTBALL_KEY } });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    this.state.scorersCache[cacheKey] = data.response || [];
                    renderScorers(this.state.scorersCache[cacheKey]);
                } catch (e) {
                    console.error("Erro ao carregar artilheiros:", e);
                    g.innerHTML = '<div class="col-span-full text-center text-red-400">Erro ao carregar artilheiros.</div>';
                }
            },

            async fetchNews(id) {
                const g = document.getElementById('news-grid'); if (!g) return;
                g.innerHTML = '<div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>';
                try {
                    const res = await fetch(API_CONFIG.getNewsUrl('soccer', id));
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const d = await res.json(); g.innerHTML = '';
                    (d.articles||[]).slice(0,9).forEach(n => {
                        if(!n.links?.web?.href) return;
                        g.innerHTML += `<a href="${n.links.web.href}" target="_blank" class="news-card group block">
                            <div class="news-img-wrapper">${n.images?.[0]?.url ? `<img src="${n.images[0].url}" class="news-img">` : ''}</div> // Usar var(--card-border-radius)
                            <div class="news-content">
                                <div><div class="news-category">Notícia</div><h3 class="news-title group-hover:text-[var(--accent)] transition">${n.headline}</h3></div>
                                <p class="news-footer"><i data-lucide="clock" class="w-3 h-3"></i> ${n.published||'Recente'}</p>
                            </div>
                        </a>`;
                    });
                    if(window.lucide) window.lucide.createIcons();
                } catch (e) { console.error("Erro ao carregar notícias:", e); g.innerHTML = '<div class="text-center text-red-400">Erro ao carregar notícias.</div>'; }
            },

            renderHistoricPilots() {
                const container = document.getElementById('historic-pilots-grid');
                if (!container) return;
                this.closeWiki(); // Ensure wiki is closed when rendering the grid
                const pilots = SPORTS_DB.formula1.historicPilots || [];
                container.innerHTML = '';
                pilots.forEach(pilotName => {
                    const card = document.createElement('div');
                    card.className = 'club-grid-card';
                    const displayName = pilotName.replace(/_/g, ' ');
                    card.onclick = () => this.loadWikiDetail(pilotName); // Usar var(--font-family-primary)
                    card.innerHTML = `<div class="w-20 h-20 flex items-center justify-center"><i data-lucide="user-square" class="w-12 h-12 text-gray-400"></i></div><span>${displayName}</span>`;
                    container.appendChild(card);
                });
                if(window.lucide) lucide.createIcons();
            },

            async renderClubs(leagueKey) {
                const container = document.getElementById('clubs-grid');
                const wikiDetail = document.getElementById('wiki-detail');
                const grid = document.getElementById('clubs-grid');
                if (!container) return;
                this.closeWiki(); // Ensure wiki is closed when rendering the grid
                
                const league = SPORTS_DB.soccer.leagues[leagueKey];
                container.innerHTML = '<div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>';

                const teamsFromApi = await this.getEspnLeagueTeams(league.id);

                container.innerHTML = '';
                if (!teamsFromApi.length) {
                    container.innerHTML = '<div class="col-span-full text-center text-gray-500 glass-panel p-10">Não foi possível carregar os clubes.</div>';
                    return;
                }

                teamsFromApi.sort((a, b) => a.displayName.localeCompare(b.displayName)).forEach(teamData => {
                    const card = document.createElement('div');
                    card.className = 'club-grid-card';
                    
                    const displayName = teamData.displayName;
                    let logoUrl = teamData.logos?.[0]?.href;
                    if (league.logoOverrides && league.logoOverrides[displayName]) {
                        logoUrl = league.logoOverrides[displayName];
                    }
                    // Encontra o nome correspondente na Wikipedia a partir do nosso DB local
                    const clubWikiName = league.clubs.find(c => c.replace(/_/g, ' ').toLowerCase() === teamData.name.toLowerCase()) || teamData.name.replace(/ /g, '_');
                    card.onclick = () => this.showTeamSchedule(teamData.id, displayName, logoUrl, clubWikiName);
 
                    const imgContent = logoUrl ? `<img src="${logoUrl}" alt="${displayName}">` : `<div class="w-20 h-20 rounded-full bg-white/10 flex items-center justify-center text-3xl" style="font-family: var(--font-family-primary);">⚽</div>`;
                    card.innerHTML = `${imgContent}<span>${displayName}</span>`;
                    container.appendChild(card);
                });
            },

            async showTeamSchedule(teamId, teamName, teamLogo, wikiName) {
                this.setView('team-schedule');
                const container = document.getElementById('view-team-schedule');
                if (!container) return;

                container.innerHTML = `
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="app.setView('clubs')" class="text-[var(--accent)] hover:text-white transition flex items-center gap-2 font-bold"><i data-lucide="arrow-left"></i> Voltar para Clubes</button>
                    </div> // Usar var(--font-family-primary)
                    <div class="flex flex-col md:flex-row items-center gap-6 mb-8 p-6 rounded-3xl bg-white/5 border border-white/10">
                        <img src="${teamLogo}" class="w-20 h-20 object-contain">
                        <div class="flex-1 text-center md:text-left">
                            <h2 class="text-3xl font-bold" style="color: var(--text-primary);">${teamName}</h2>
                            <button onclick="app.loadWikiDetail('${wikiName}')" class="mt-2 text-sm text-gray-400 hover:text-[var(--accent)] transition">Ver na Wikipedia <i data-lucide="external-link" class="inline w-3 h-3"></i></button>
                        </div>
                    </div>
                    <!-- TABS for Schedule and Roster -->
                    <div id="team-view-tabs" class="flex items-center border-b border-white/10 mb-6">
                        <button data-tab="schedule" class="px-4 py-3 text-sm font-bold border-b-2 transition whitespace-nowrap text-white border-[var(--accent)]">Jogos</button>
                        <button data-tab="roster" class="px-4 py-3 text-sm font-bold border-b-2 transition whitespace-nowrap text-gray-400 border-transparent hover:text-white" style="font-family: var(--font-family-primary);">Elenco</button>
                    </div>

                    <!-- TAB CONTENT -->
                    <div id="team-tab-schedule">
                        <h3 class="text-xl font-bold mb-6" style="color: var(--text-primary); font-family: var(--font-family-primary);">Próximos Jogos</h3>
                        <div id="team-schedule-list" class="space-y-4">
                            <div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>
                        </div>
                        <h3 class="text-xl font-bold mt-10 mb-6" style="color: var(--text-primary);">Últimos Resultados</h3>
                        <div id="team-results-list" class="space-y-4"></div>
                    </div>
                    <div id="team-tab-roster" class="hidden">
                        <div id="team-roster-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="col-span-full py-20 flex justify-center"><div class="loader-ring"></div></div>
                        </div>
                    </div>
                `;
                if(window.lucide) lucide.createIcons();

                // Add event listeners for tabs
                container.querySelectorAll('#team-view-tabs button').forEach(button => {
                    button.addEventListener('click', () => {
                        // Update button styles
                        container.querySelectorAll('#team-view-tabs button').forEach(btn => {
                            btn.className = 'px-4 py-3 text-sm font-bold border-b-2 transition whitespace-nowrap text-gray-400 border-transparent hover:text-white';
                        });
                        button.className = 'px-4 py-3 text-sm font-bold border-b-2 transition whitespace-nowrap text-white border-[var(--accent)]';

                        // Update content visibility
                        document.getElementById('team-tab-schedule').classList.toggle('hidden', button.dataset.tab !== 'schedule');
                        document.getElementById('team-tab-roster').classList.toggle('hidden', button.dataset.tab !== 'roster');
                    });
                });

                // Fetch both schedule and roster
                const sport = this.state.currentSport;
                const league = SPORTS_DB[sport].leagues[this.state.currentLeague];
                
                // Fetch Schedule
                try {
                    const res = await fetch(API_CONFIG.getTeamScheduleUrl(sport, league.id, teamId));
                    const data = await res.json();
                    this.renderTeamScheduleAndResults(data.events || [], teamId);
                } catch (e) {
                    document.getElementById('team-schedule-list').innerHTML = '<div class="text-center text-red-400">Erro ao carregar os jogos do time.</div>';
                    console.error("Fetch team schedule error:", e);
                }

                // Fetch Roster
                try {
                    const res = await fetch(API_CONFIG.getTeamRosterUrl(league.id, teamId));
                    const data = await res.json();
                    this.renderTeamRoster(data);
                } catch (e) {
                    document.getElementById('team-roster-list').innerHTML = '<div class="text-center text-red-400">Erro ao carregar o elenco do time.</div>';
                    console.error("Fetch team roster error:", e);
                }
            },

            renderTeamScheduleAndResults(events, teamId) {
                const upcomingList = document.getElementById('team-schedule-list');
                const resultsList = document.getElementById('team-results-list');
                if (!upcomingList || !resultsList) return;

                upcomingList.innerHTML = '';
                resultsList.innerHTML = '';

                const now = new Date();
                // Mantém os próximos jogos ordenados cronologicamente (como vêm da API)
                const upcomingEvents = events.filter(e => new Date(e.date) >= now);
                // Ordena os jogos passados para ter os mais recentes primeiro
                const pastEvents = events.filter(e => new Date(e.date) < now).sort((a, b) => new Date(b.date) - new Date(a.date));

                // --- Renderizar Próximos Jogos ---
                if (upcomingEvents.length === 0) {
                    upcomingList.innerHTML = '<div class="text-center text-gray-500 glass-panel p-10">Nenhum jogo futuro encontrado.</div>';
                } else {
                    upcomingEvents.forEach(ev => {
                        const comp = ev.competitions[0];
                        const home = comp.competitors.find(c => c.homeAway === 'home');
                        const away = comp.competitors.find(c => c.homeAway === 'away');
                        const isHomeGame = String(home.id) === String(teamId);
                        const opponent = isHomeGame ? away : home;

                        const eventDate = new Date(ev.date);
                        const dateString = eventDate.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' });
                        const timeString = eventDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                        const item = document.createElement('div');
                        item.className = 'glass-panel !p-4 flex items-center gap-4';
                        item.innerHTML = `
                            <div class="text-center w-20 shrink-0" style="font-family: var(--font-family-primary);">
                                <div class="font-bold text-sm" style="color: var(--text-primary);">${dateString}</div>
                                <div class="text-xs text-gray-400">${timeString}</div>
                            </div>
                            <div class="w-px h-10 bg-white/10"></div>
                            <div class="flex items-center gap-4 flex-1">
                                <img src="${opponent.team.logos?.[0]?.href}" class="w-8 h-8 object-contain">
                                <div>
                                    <div class="font-bold" style="color: var(--text-primary); font-family: var(--font-family-primary);">${opponent.team.displayName}</div>
                                    <div class="text-xs text-gray-400">${ev.shortName}</div>
                                </div>
                            </div>
                            <div class="text-xs font-bold uppercase text-gray-500 w-16 text-center">${isHomeGame ? 'CASA' : 'FORA'}</div>
                        `;
                        upcomingList.appendChild(item);
                    });
                }

                // --- Renderizar Resultados Passados (últimos 5) ---
                if (pastEvents.length === 0) {
                    resultsList.innerHTML = '<div class="text-center text-gray-500 glass-panel p-10">Nenhum resultado recente encontrado.</div>';
                } else {
                    pastEvents.slice(0, 5).forEach(ev => {
                        const comp = ev.competitions[0];
                        const home = comp.competitors.find(c => c.homeAway === 'home');
                        const away = comp.competitors.find(c => c.homeAway === 'away');
                        const isOurTeamHome = String(home.id) === String(teamId);
                        const ourTeam = isOurTeamHome ? home : away;
                        const opponent = isOurTeamHome ? away : home;

                        const ourScore = parseInt(ourTeam.score || '0');
                        const opponentScore = parseInt(opponent.score || '0');
                        
                        let resultIndicator = 'E';
                        let resultColorClass = 'bg-gray-500';
                        if (ourScore > opponentScore) {
                            resultIndicator = 'V';
                            resultColorClass = 'bg-green-500';
                        } else if (ourScore < opponentScore) {
                            resultIndicator = 'D';
                            resultColorClass = 'bg-red-500';
                        }

                        const eventDate = new Date(ev.date);
                        const dateString = eventDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });

                        const item = document.createElement('div');
                        item.className = 'glass-panel !p-4 flex items-center gap-4';
                        item.innerHTML = `
                            <div class="flex items-center justify-center w-12 h-12 rounded-xl text-white font-bold text-lg ${resultColorClass} shrink-0" style="font-family: var(--font-family-primary);">${resultIndicator}</div>
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <img src="${home.team.logos?.[0]?.href}" class="w-6 h-6 object-contain">
                                    <span class="font-medium ${home.id === teamId ? 'font-bold' : ''}" style="color: var(--text-primary);">${home.team.displayName}</span>
                                    <span class="ml-auto font-bold text-lg" style="color: var(--text-primary);">${home.score || '0'}</span>
                                </div>
                                <div class="flex items-center gap-3 mt-2">
                                    <img src="${away.team.logos?.[0]?.href}" class="w-6 h-6 object-contain">
                                    <span class="font-medium ${away.id === teamId ? 'font-bold' : ''}" style="color: var(--text-primary);">${away.team.displayName}</span>
                                    <span class="ml-auto font-bold text-lg" style="color: var(--text-primary);">${away.score || '0'}</span>
                                </div>
                            </div>
                            <div class="w-px h-10 bg-white/10 mx-2"></div>
                            <div class="text-center w-24 shrink-0" style="font-family: var(--font-family-primary);">
                                <div class="text-xs text-gray-400">${ev.competitions[0].league?.shortName || ev.league?.name || ''}</div>
                                <div class="font-bold text-sm mt-1" style="color: var(--text-primary);">${dateString}</div>
                            </div>
                        `;
                        resultsList.appendChild(item);
                    });
                }
            },

            renderTeamRoster(data) {
                const rosterList = document.getElementById('team-roster-list');
                if (!rosterList) return;

                if (!data || !data.athletes || data.athletes.length === 0) {
                    rosterList.innerHTML = '<div class="col-span-full text-center text-gray-500 glass-panel p-10">Elenco não disponível.</div>';
                    return;
                }

                rosterList.innerHTML = '';
                // The data is grouped by position.
                data.athletes.forEach(positionGroup => {
                    rosterList.innerHTML += `<h4 class="col-span-full text-lg font-bold text-[var(--accent)] mt-6 mb-2">${positionGroup.position}</h4>`;
                    positionGroup.items.forEach(player => { // Usar var(--font-family-primary)
                        const card = document.createElement('div');
                        card.className = 'scorer-card'; // Re-using scorer card style
                        card.innerHTML = `
                            <div class="scorer-rank text-[var(--accent)]">${player.jersey}</div>
                            <img src="${player.headshot?.href || ''}" class="scorer-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2EwYTBiMiI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMy41YzEuOTMgMCAzLjUgMS41NyAzLjUgMy41UzEzLjkzIDEyLjUgMTIgMTIuNXMtMy41LTEuNTctMy41LTMuNVMxMC4wNyA1LjUgMTIgNS41em0wIDEzLjVjLTIuOTcgMC02LjYxIDEuNDYtOC4wMyA0LjA0QzQuNDIgMjEuMjYgOC4wNiAyMiAxMiAyMnMyLjYxLS43NCAzLjk3LTEuNDZjLTEuNDItMi41OC01LjA2LTQuMDQtOC4wMy00LjA0eiIvPjwvc3ZnPg=='">
                            <div class="flex-1">
                                <div class="font-bold text-lg" style="color: var(--text-primary); font-family: var(--font-family-primary);">${player.fullName}</div>
                                <div class="text-sm font-medium flex items-center" style="color: var(--text-muted)">
                                    <img src="${player.flag?.href || ''}" class="w-4 h-4 mr-2">
                                    <span>${player.nationality}</span>
                                </div>
                            </div>
                        `;
                        rosterList.appendChild(card);
                    });
                });
            },

            searchWiki() {
                let q = '';
                if (this.state.view === 'clubs') {
                    q = document.getElementById('wiki-search-input').value;
                } else if (this.state.view === 'historic-pilots') {
                    q = document.getElementById('wiki-pilot-search-input').value;
                }
                if(!q) return;
                this.loadWikiDetail(q);
            },

            async loadWikiDetail(searchTerm, logoUrl = null) {
                const container = document.getElementById('wiki-content-area');
                const wikiDetail = document.getElementById('wiki-detail');
                if (!container || !wikiDetail) return;

                if (this.state.view === 'clubs') {
                    document.getElementById('clubs-grid').classList.add('hidden');
                    document.getElementById('wiki-search-input').parentElement.classList.add('hidden');
                } else if (this.state.view === 'team-schedule') {
                    document.getElementById('view-team-schedule').classList.add('hidden');
                } else if (this.state.view === 'historic-pilots') {
                    document.getElementById('historic-pilots-grid').classList.add('hidden');
                    document.getElementById('wiki-pilot-search-input').parentElement.classList.add('hidden');
                } else if (this.state.view === 'scorers') {
                    document.getElementById('scorers-grid').classList.add('hidden');
                    document.getElementById('scorers-header').classList.add('hidden');
                }
                wikiDetail.classList.remove('hidden');
                container.innerHTML = '<div class="flex flex-col items-center justify-center py-20"><div class="loader-ring"></div></div>';
                
                if (!logoUrl && this.state.currentSport === 'soccer') {
                    try {
                        // ERRO CORRIGIDO: A variável 'league' não estava definida neste escopo.
                        const league = SPORTS_DB.soccer.leagues[this.state.currentLeague];
                        const espnTeams = await this.getEspnLeagueTeams(league.id);
                        const searchName = searchTerm.replace(/_/g, ' ').toLowerCase();
                        // ERRO CORRIGIDO: A lógica abaixo usava 'espnTeamsMap', que não existe, causando um erro.
                        // A busca foi simplificada para usar o 'find' que já estava presente.
                        const team = espnTeams.find(t => t.name.toLowerCase() === searchName || t.displayName.toLowerCase() === searchName);
                        logoUrl = team?.logos?.[0]?.href;
                    } catch(e) { console.error("Error fetching logo for wiki detail:", e); }
                }
                
                try {
                    const queryTerm = searchTerm.replace(/_/g, ' ');
                    const searchRes = await fetch(API_CONFIG.getWikiSearchUrl(queryTerm));
                    const searchData = await searchRes.json();
                    if(!searchData.query || !searchData.query.search || searchData.query.search.length === 0) {
                         container.innerHTML = `<p class="text-center text-red-400">Conteúdo para "${queryTerm}" não encontrado na Wikipedia.</p>`; return;
                    }
                    const bestMatchTitle = searchData.query.search[0].title;
                    const detailRes = await fetch(API_CONFIG.getWikiDetailUrl(bestMatchTitle));
                    const detailData = await detailRes.json();
                    const page = Object.values(detailData.query.pages)[0];
                    
                    const finalLogoUrl = page.thumbnail?.source || logoUrl;
                    let html = `<div class="flex flex-col md:flex-row items-start gap-8 mb-8">`;
                    if (finalLogoUrl) {
                        html += `<img src="${finalLogoUrl}" class="w-32 h-32 object-cover md:object-contain rounded-2xl border border-white/10 p-2 bg-white/5 shrink-0 mx-auto md:mx-0">`; // Usar var(--card-border-radius)
                    }
                    html += `<div class="flex-1 pt-2 text-center md:text-left"><h2 class="text-4xl font-black leading-tight" style="color: var(--text-primary)">${page.title}</h2></div></div>`;
                    html += `<div class="text-lg leading-relaxed" style="color: var(--text-primary)">${page.extract ? page.extract.replace(/\n/g, '<br><br>') : 'Sem descrição.'}</div>`;
                    container.innerHTML = html;
                } catch(e) {
                    console.error("Erro ao carregar detalhes da Wikipedia:", e);
                    container.innerHTML = '<p class="text-center text-red-400">Erro de conexão ao carregar detalhes.</p>';
                }
            },

            closeWiki() {
                document.getElementById('wiki-detail').classList.add('hidden');
                if (this.state.view === 'clubs') {
                    document.getElementById('clubs-grid').classList.remove('hidden');
                    document.getElementById('wiki-search-input').parentElement.classList.remove('hidden');
                } else if (this.state.view === 'team-schedule') {
                    this.setView('clubs'); // Volta para a lista de clubes
                } else if (this.state.view === 'historic-pilots') {
                    document.getElementById('historic-pilots-grid').classList.remove('hidden');
                    document.getElementById('wiki-pilot-search-input').parentElement.classList.remove('hidden');
                } else if (this.state.view === 'scorers') {
                    document.getElementById('scorers-grid').classList.remove('hidden');
                    document.getElementById('scorers-header').classList.remove('hidden');
                }
            },

            async openMatch(id) {
                const m = document.getElementById('match-modal');
                if (!m) return;

                // Find the card in the main view to check for score changes
                const matchCard = document.querySelector(`.match-card[data-event-id='${id}']`);
                const oldHomeScore = matchCard ? parseInt(matchCard.getAttribute('data-home-score')) : -1;
                const oldAwayScore = matchCard ? parseInt(matchCard.getAttribute('data-away-score')) : -1;

                const l = SPORTS_DB.soccer.leagues[this.state.currentLeague];
                m.classList.add('open'); 
                m.querySelector('.modal-content').className = `modal-content`;
                document.getElementById('modal-bg').style.backgroundImage = `url('${l.bg}')`;
                
                try {
                    const res = await fetch(API_CONFIG.getGameSummaryUrl(l.id, id));
                    const d = await res.json();
                    this.state.currentMatchData = d;

                    // Check for score changes and trigger animation
                    if (d.header && matchCard) {
                        const h = d.header.competitions[0].competitors.find(x=>x.homeAway==='home');
                        const a = d.header.competitions[0].competitors.find(x=>x.homeAway==='away');
                        const newHomeScore = parseInt(h.score || '0');
                        const newAwayScore = parseInt(a.score || '0');

                        if (newHomeScore > oldHomeScore) {
                            this.triggerGoalAnimation(id, h);
                            // Update score on the card
                            document.getElementById(`score-home-${id}`).innerText = newHomeScore;
                            matchCard.setAttribute('data-home-score', newHomeScore);
                        }
                        if (newAwayScore > oldAwayScore) {
                            this.triggerGoalAnimation(id, a);
                            // Update score on the card
                            document.getElementById(`score-away-${id}`).innerText = newAwayScore;
                            matchCard.setAttribute('data-away-score', newAwayScore);
                        }

                        // NEW: Check for card events
                        const allEvents = d.header.competitions[0].details || [];
                        const cardEvents = allEvents.filter(e => e.type === 'yellowcard' || e.type === 'redcard');
                        const oldCardCount = parseInt(matchCard.getAttribute('data-card-events')) || 0;

                        if (cardEvents.length > oldCardCount) {
                            // Animate for the most recent new card
                            const lastNewCard = cardEvents[cardEvents.length - 1];
                            const team = h.team.id === lastNewCard.team.id ? h : a;
                            this.triggerCardAnimation(id, lastNewCard, team);
                            // Update the count on the element to prevent re-animation
                            matchCard.setAttribute('data-card-events', cardEvents.length);
                        }

                        const subEvents = allEvents.filter(e => e.type === 'substitution');
                        const oldSubCount = parseInt(matchCard.getAttribute('data-substitution-events')) || 0;

                        if (subEvents.length > oldSubCount) {
                            const lastNewSub = subEvents[subEvents.length - 1];
                            const team = h.team.id === lastNewSub.team.id ? h : a;
                            this.triggerSubstitutionAnimation(id, lastNewSub, team);
                            matchCard.setAttribute('data-substitution-events', subEvents.length);
                        }

                        // NEW: Check for VAR events
                        const varEvents = allEvents.filter(e => e.text && (e.text.toLowerCase().includes('var') || e.text.toLowerCase().includes('revisão')));
                        const oldVarCount = parseInt(matchCard.getAttribute('data-var-events')) || 0;

                        if (varEvents.length > oldVarCount) {
                            const lastNewVar = varEvents[varEvents.length - 1];
                            this.triggerVARAnimation(id, lastNewVar);
                            matchCard.setAttribute('data-var-events', varEvents.length);
                        }
                    }

                    this.renderMatchDetail(d);
                } catch (e) {
                    console.error("Erro ao abrir detalhes da partida:", e);
                    // Opcional: Adicionar uma mensagem de erro no modal se ele estiver aberto
                }
            },

            renderMatchDetail(d) {
                if(!d?.header) return;
                const h = d.header.competitions[0].competitors.find(x=>x.homeAway==='home');
                const a = d.header.competitions[0].competitors.find(x=>x.homeAway==='away');
                
                const setText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };
                const setSrc = (id, src) => { const el = document.getElementById(id); if(el) el.src = src; };

                setText('modal-home-name', h.team.displayName); setText('modal-away-name', a.team.displayName);
                setSrc('modal-home-logo', h.team.logos?.[0]?.href); setSrc('modal-away-logo', a.team.logos?.[0]?.href);
                // Correção para evitar 'undefined' no placar
                setText('modal-score', `${h.score || '0'} - ${a.score || '0'}`);
                
                const status = d.header.status;
                const competitionStatus = d.header.competitions[0].status;
                const mainStatus = status || competitionStatus; // Fallback to competitionStatus if the main one is missing
                
                // Limpa qualquer cronômetro anterior do modal
                if (this.state.matchTimerInterval) {
                    clearInterval(this.state.matchTimerInterval);
                    this.state.matchTimerInterval = null;
                }
                
                setText('modal-status', mainStatus?.type?.shortDetail || 'N/D');
                if (mainStatus?.type?.state === 'in' && competitionStatus) {
                    // Inicia o cronômetro em tempo real
                    this.startLiveMatchTimer(competitionStatus, d.header.competitions[0].details);
                } else {
                    setText('modal-time', mainStatus?.type?.state !== 'pre' ? (mainStatus?.type?.description || '') : ''); // Usar var(--font-family-primary)
                }

                // Render Tabs
                const tabsContainer = document.getElementById('match-modal-tabs');
                const lineupsData = d.lineups;
                let tabsHtml = `<button data-tab="summary" onclick="app.switchMatchModalTab('summary')">Resumo</button>`;
                tabsHtml += `<button data-tab="broadcast" onclick="app.switchMatchModalTab('broadcast')">Transmissão</button>`;
                tabsHtml += `<button data-tab="lineups" onclick="app.switchMatchModalTab('lineups')">Escalações</button>`;
                tabsContainer.innerHTML = tabsHtml;
                this.switchMatchModalTab('summary'); // Activate summary tab by default
                
                const statDiv = document.getElementById('modal-stats');
                if (statDiv) {
                    const boxscore = d.boxscore || d.gameInfo?.boxscore; // Check in two possible locations
                    if(boxscore?.teams) {
                        const hS = boxscore.teams.find(t=>t.team.id===h.team.id)?.statistics||[];
                        const aS = boxscore.teams.find(t=>t.team.id===a.team.id)?.statistics||[];
                        const statsHtml = hS.map(s => {
                            const hV = s.displayValue; 
                            const aV = aS.find(x=>x.label===s.label)?.displayValue||'0';
                            const hNum = parseFloat(String(hV).replace('%',''));
                            const aNum = parseFloat(String(aV).replace('%',''));
                            const tot = (hNum || 0) + (aNum || 0) || 1;
                            const hPercent = (hNum / tot) * 100;
                            return `<div class="mb-4"><div class="flex justify-between text-xs font-bold uppercase text-gray-400 mb-2"><span>${hV}</span><span>${s.label}</span><span>${aV}</span></div><div class="h-2 bg-white/10 rounded-full flex overflow-hidden"><div class="bg-[var(--accent)] h-full" style="width:${hPercent}%"></div></div></div>`;
                        }).join(''); // Usar var(--font-family-primary)

                        if (statsHtml) {
                            statDiv.innerHTML = statsHtml;
                        } else {
                            statDiv.innerHTML = '<div class="text-center text-gray-500 py-4">Estatísticas não disponíveis.</div>';
                        }
                    } else {
                        statDiv.innerHTML = '<div class="text-center text-gray-500 py-4">Estatísticas não disponíveis.</div>';
                    }
                }

                // Linha do Tempo (Restaurada)
                const tl = document.getElementById('modal-timeline');
                if (tl) {
                    // Prioritize keyEvents. As a fallback, filter 'details' to find event-like items.
                    let events = d.keyEvents || [];
                    if (!events.length && d.header?.competitions?.[0]?.details) {
                        events = d.header.competitions[0].details.filter(e => e.clock && (e.text || e.shortText));
                    }
                    
                    if (events.length > 0) {
                        const timelineHtml = events.slice().reverse().map(e => {
                            const text = e.text || e.shortText || "Lance";
                            const type = e.type?.text || (typeof e.type === 'string' && e.type) || "Jogo";
                            const clock = e.clock?.displayValue || "-";
                            
                            let icon = '•';
                            const lowerType = type.toLowerCase();
                            if (lowerType.includes('goal')) icon = '⚽️';
                            else if (lowerType.includes('yellow card')) icon = '🟨';
                            else if (lowerType.includes('red card')) icon = '🟥'; // Usar var(--font-family-primary)
                            else if (lowerType.includes('substitution')) icon = '🔄';
                            return `<div class="relative pb-6 border-l border-white/10 pl-6 last:pb-0 last:border-transparent" style="border-color: var(--glass-border)">
                                <span class="absolute -left-[9px] bg-black text-xs font-bold text-[var(--accent)] border border-[var(--accent)] rounded px-1">${clock}</span>
                                <div class="text-sm font-bold" style="color: var(--text-primary)">${icon} ${text}</div>
                                <div class="text-xs text-gray-500 uppercase mt-1">${type}</div>
                            </div>`;
                        }).join('');
                        tl.innerHTML = timelineHtml;
                    } else {
                        tl.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhum lance importante registrado.</div>';
                    }
                }

                // Render Lineups into its tab
                this.renderEspnLineups(d);
            },

            async fetchBroadcastForMatch() {
                const container = document.getElementById('match-tab-broadcast');
                if (!container || !this.state.currentMatchData?.header) {
                    if (container) container.innerHTML = '<div class="text-center text-gray-500 p-10">Dados da partida não encontrados.</div>';
                    return;
                }

                container.innerHTML = '<div class="py-20 flex justify-center"><div class="loader-ring"></div></div>';

                // Usa o nome completo do evento para uma busca mais precisa
                let matchName = this.state.currentMatchData.header.name;

                // Fallback para construir o nome da partida se `header.name` não existir
                if (!matchName) {
                    const competition = this.state.currentMatchData.header.competitions?.[0];
                    const homeTeam = competition?.competitors?.find(c => c.homeAway === 'home');
                    const awayTeam = competition?.competitors?.find(c => c.homeAway === 'away');
                    if (homeTeam && awayTeam) {
                        matchName = `${homeTeam.team.displayName} vs ${awayTeam.team.displayName}`;
                    }
                }

                if (!matchName) {
                    container.innerHTML = '<div class="text-center text-gray-500 p-10">Não foi possível determinar o nome da partida para a busca.</div>';
                    return;
                }
                
                let allEmbeds = [];

                // --- Fonte 1: esportesembed.top (Geração Direta) ---
                const finalMatchNameEsportes = matchName.replace(/ em /gi, ' x ').replace(/ vs /gi, ' x ');
                const matchSlugEsportes = finalMatchNameEsportes.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos
                    .replace(/[^a-z0-9\s-x]/g, '') // Remove caracteres especiais, permitindo 'x'
                    .trim().replace(/\s+/g, '-'); // Substitui espaços por hífens

                for (let i = 1; i <= 3; i++) { // Gera 3 opções de canais
                    allEmbeds.push({
                        embed_url: API_CONFIG.getEsportesEmbedUrl(`${matchSlugEsportes}-${i}`),
                        provider: `Fonte A - Opção ${i}`,
                        quality: 'HD'
                    });
                }

                // --- Fonte 2: reidoscanais.io (API Fetch como Fallback) ---
                try {
                    const finalMatchNameRei = matchName.replace(/ em /gi, ' vs ');
                    const matchSlugRei = finalMatchNameRei.toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        .replace(/[^a-z0-9\s-]/g, '')
                        .trim().replace(/\s+/g, '-');

                    const res = await fetch(API_CONFIG.getReiDosCanaisMatchUrl(matchSlugRei));
                    if (res.ok) {
                        const searchResults = await res.json();
                        const matchData = Array.isArray(searchResults) ? searchResults[0] : searchResults;

                        if (matchData && matchData.embeds && matchData.embeds.length > 0) {
                            const fallbackEmbeds = matchData.embeds.map(embed => ({ ...embed, provider: `Fonte B - ${embed.provider || 'Opção'}` }));
                            allEmbeds.push(...fallbackEmbeds);
                        }
                    }
                } catch (e) {
                    console.warn("Fonte de fallback (Rei dos Canais) falhou:", e);
                }

                // Renderiza todos os embeds encontrados
                if (allEmbeds.length > 0) {
                    this.renderBroadcastForMatch(allEmbeds);
                } else {
                    container.innerHTML = '<div class="text-center text-gray-500 p-10">Nenhuma transmissão encontrada para esta partida.</div>';
                }
            },

            renderBroadcastForMatch(embeds) {
                const container = document.getElementById('match-tab-broadcast');
                if (!container) return;

                if (!embeds || embeds.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 p-10">Nenhuma transmissão encontrada para esta partida.</div>';
                    return;
                } // Usar var(--card-border-radius)

                container.innerHTML = `
                    <div class="aspect-video bg-black rounded-xl mb-6 overflow-hidden border border-[var(--glass-border)]">
                        <iframe id="broadcast-player" class="w-full h-full" src="${embeds[0].embed_url}" frameborder="0" allowfullscreen></iframe>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 tracking-widest">Fontes de Transmissão</h4>
                        <div id="broadcast-channel-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                    </div>
                `;

                const channelListContainer = document.getElementById('broadcast-channel-list');
                const player = document.getElementById('broadcast-player');

                embeds.forEach((embed, index) => {
                    const card = document.createElement('button');
                    card.className = `scorer-card !p-3 flex items-center gap-3 cursor-pointer hover:border-[var(--accent)] w-full ${index === 0 ? 'border-[var(--accent)]' : ''}`;
                    card.innerHTML = ` // Usar var(--font-family-primary)
                        <div class="w-10 h-10 bg-white/5 rounded-lg flex items-center justify-center shrink-0"><i data-lucide="tv-2" class="w-5 h-5 text-[var(--accent)]"></i></div>
                        <div class="flex-1 text-left"><div class="font-bold text-base" style="color: var(--text-primary);">${embed.provider}</div><div class="text-xs text-gray-400">${embed.quality || 'HD'}</div></div>
                    `;
                    card.onclick = () => {
                        player.src = embed.embed_url;
                        channelListContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('border-[var(--accent)]'));
                        card.classList.add('border-[var(--accent)]');
                    };
                    channelListContainer.appendChild(card);
                });
                if(window.lucide) lucide.createIcons();
            },

            renderEspnLineups(matchData) {
                const homeContainer = document.getElementById('home-lineup');
                const awayContainer = document.getElementById('away-lineup');
                const renderNotAvailable = (container) => {
                    if(container) container.innerHTML = `<div class="text-center text-gray-500 py-10">Escalação não disponível.</div>`;
                };

                const lineups = matchData.rosters || matchData.lineups;
                if (!lineups || lineups.length < 2) {
                    renderNotAvailable(homeContainer);
                    renderNotAvailable(awayContainer);
                    return;
                }

                const espnHomeTeam = matchData.header.competitions[0].competitors.find(c => c.homeAway === 'home');
                const espnAwayTeam = matchData.header.competitions[0].competitors.find(c => c.homeAway === 'away');
                const homeLineupData = lineups.find(l => String(l.team.id) === String(espnHomeTeam.team.id));
                const awayLineupData = lineups.find(l => String(l.team.id) === String(espnAwayTeam.team.id));
                const coaches = matchData.coaches || [];
                const homeCoach = coaches.find(c => String(c.team.id) === String(espnHomeTeam.team.id));
                const awayCoach = coaches.find(c => String(c.team.id) === String(espnAwayTeam.team.id));

                if (homeLineupData) {
                    homeContainer.innerHTML = this.generateTacticalBoardHTML(homeLineupData, espnHomeTeam, homeCoach, 'home');
                    // Set default formation after a brief timeout to ensure DOM is updated
                    const homeFormation = homeLineupData.formation;
                    const homeFormationToSet = (homeFormation && this.formations[homeFormation]) ? homeFormation : 'default';
                    setTimeout(() => this.setTacticalFormation('home', homeFormationToSet), 0);
                } else {
                    renderNotAvailable(homeContainer);
                }

                if (awayLineupData) {
                    awayContainer.innerHTML = this.generateTacticalBoardHTML(awayLineupData, espnAwayTeam, awayCoach, 'away');
                    const awayFormation = awayLineupData.formation;
                    const awayFormationToSet = (awayFormation && this.formations[awayFormation]) ? awayFormation : 'default';
                    setTimeout(() => this.setTacticalFormation('away', awayFormationToSet), 0);
                } else {
                    renderNotAvailable(awayContainer);
                }
            },

            generateTacticalBoardHTML(lineupData, espnTeamData, coachData, teamType) {
                const players = lineupData?.roster || lineupData?.athletes || [];
                if (!lineupData || players.length === 0) {
                    return `<div class="text-center text-gray-500 py-10">Escalação não disponível.</div>`;
                }

                const formation = lineupData.formation;
                const starters = players.filter(p => p.starter);
                const subs = players.filter(p => !p.starter);

                // --- Header ---
                let headerHtml = `<div class="flex items-center gap-3 mb-4">
                    <img src="${espnTeamData.team.logos[0].href}" class="w-8 h-8 object-contain">
                    <div style="font-family: var(--font-family-primary);">
                        <div class="font-bold text-lg" style="color: var(--text-primary)">${espnTeamData.team.displayName}</div>
                        ${formation ? `<div class="text-sm font-medium text-[var(--accent)]">${formation}</div>` : ''}
                    </div>
                </div>`;

                // --- Tactical Field ---
                let tacticalFieldHtml = `<div class="stadium-container">
                    <div class="pitch" id="pitch-${teamType}"> // Usar var(--card-border-radius)
                        <!-- Markings -->
                        <div class="marking center-line"></div><div class="marking center-circle"></div>
                        <div class="marking penalty-area-top"></div><div class="marking penalty-area-bottom"></div>
                        <div class="marking goal-area-top"></div><div class="marking goal-area-bottom"></div>
                        <div class="marking penalty-arc-top"></div><div class="marking penalty-arc-bottom"></div>
                        <div class="goal-post goal-top"></div><div class="goal-post goal-bottom"></div>
                        <!-- Players -->
                        ${starters.map((p, index) => {
                            const player = p.athlete;
                            const teamColor = espnTeamData.team.color || '333333';
                            const isGk = player.position?.abbreviation === 'GK';
                            
                            // Helper to get contrasting text color
                            const getTextColorForBg = (hex) => {
                                if (!hex || hex.length < 6) return '#FFFFFF';
                                const r = parseInt(hex.substring(0, 2), 16);
                                const g = parseInt(hex.substring(2, 4), 16);
                                const b = parseInt(hex.substring(4, 6), 16);
                                return ((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128 ? '#000000' : '#FFFFFF';
                            };
                            const finalTextColor = isGk ? '#FFFFFF' : getTextColorForBg(teamColor);

                            return `<div class="player" id="p-${teamType}-${index}" title="${player.displayName}">
                                        <div class="kit" style="background-color: #${isGk ? '333333' : teamColor}; color: ${finalTextColor};">
                                            <div class="kit-name">${player.shortName || player.displayName?.split(' ').pop() || 'Jogador'}</div>
                                            <div class="kit-number" style="font-family: var(--font-family-primary);">${player.jersey || '-'}</div>
                                        </div>
                                        <div class="player-shadow"></div>
                                    </div>`;
                        }).join('')}
                    </div>
                </div>`;

                // --- Substitutes and Coach ---
                let subsHtml = '';
                if (subs.length > 0) {
                    subsHtml += '<h4 class="text-xs font-bold text-gray-500 uppercase mt-8 mb-3 tracking-widest">Reservas</h4>';
                    subsHtml += '<div class="space-y-3">';
                    subs.forEach(p => {
                        const player = p.athlete;
                        subsHtml += `<div class="flex items-center text-sm opacity-80" style="font-family: var(--font-family-primary);">
                                            <span class="font-mono font-bold w-8 text-gray-500">${player.jersey || '-'}</span>
                                            <span style="color: var(--text-primary)">${player.displayName || 'Jogador N/D'}</span>
                                            <span class="ml-auto text-xs text-gray-500">${player.position?.abbreviation || ''}</span>
                                         </div>`;
                    });
                    subsHtml += '</div>';
                }
                
                const coachHtml = coachData ? `<h4 class="text-xs font-bold text-gray-500 uppercase mt-6 mb-3 tracking-widest" style="font-family: var(--font-family-secondary);">Técnico</h4><div class="flex items-center text-sm"><span style="color: var(--text-primary); font-family: var(--font-family-primary);">${coachData.displayName || coachData.fullName}</span></div>` : '';

                return headerHtml + tacticalFieldHtml + subsHtml + coachHtml;
            },

             triggerGoalAnimation(eventId, scoringTeam) {
                 const matchCard = document.querySelector(`.match-card[data-event-id='${eventId}']`);
                 const elGoalOverlay = document.getElementById(`goal-overlay-${eventId}`);
                 const elGoalContent = elGoalOverlay ? elGoalOverlay.querySelector('.unified-goal-content') : null;
                 const elGoalLogo = document.getElementById(`goal-overlay-logo-${eventId}`);
                 const elGoalOs = document.getElementById(`goal-text-os-${eventId}`);
                 const isHomeGoal = scoringTeam.homeAway === 'home';
                 const scoreEl = document.getElementById(`score-${isHomeGoal ? 'home' : 'away'}-${eventId}`);
 
                 if (!matchCard || !elGoalOverlay || !elGoalContent || !elGoalLogo || !elGoalOs || !scoreEl) return;
 
                 scoreEl.classList.add('score-flash-anim');
                 setTimeout(() => scoreEl.classList.remove('score-flash-anim'), 600);
 
                 matchCard.classList.add('goal-shake');
                 setTimeout(() => matchCard.classList.remove('goal-shake'), 800);
 
                 elGoalLogo.src = scoringTeam.team.logos?.[0]?.href || '';
                 const primaryColor = scoringTeam.team.color;
                 const secondaryColor = scoringTeam.team.alternateColor || primaryColor;
                 const getTextColorForBg = (hex) => {
                     if (!hex || hex.length < 6) return 'var(--text-invert)';
                     try {
                         const r = parseInt(hex.substring(0, 2), 16);
                         const g = parseInt(hex.substring(2, 4), 16);
                         const b = parseInt(hex.substring(4, 6), 16);
                         return ((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128 ? '#000000' : '#FFFFFF';
                     } catch (e) { return 'var(--text-invert)'; }
                 };
 
                 elGoalOverlay.className = "unified-full-overlay";
                 if (primaryColor) {
                     elGoalOverlay.style.background = `linear-gradient(90deg, #${primaryColor} 0%, #${secondaryColor} 100%)`;
                     elGoalOverlay.style.color = getTextColorForBg(primaryColor);
                 } else {
                     elGoalOverlay.classList.add('bg-goal-generic');
                 }
 
                 elGoalContent.classList.remove('animate');
                 elGoalOs.innerText = "";
 
                 elGoalOverlay.classList.remove('active');
                 setTimeout(() => elGoalOverlay.classList.add('active'), 50);
 
                 setTimeout(() => {
                     elGoalContent.classList.add('animate');
                     elGoalOs.style.opacity = 1;
 
                     let oCount = 0;
                     const maxOs = 10;
                     if (this.state.goalIntervals[eventId]) clearInterval(this.state.goalIntervals[eventId]);
 
                     this.state.goalIntervals[eventId] = setInterval(() => {
                         elGoalOs.innerText += "O";
                         oCount++;
                         if (oCount >= maxOs) clearInterval(this.state.goalIntervals[eventId]);
                     }, 30);
                 }, 200);
 
                 setTimeout(() => {
                     elGoalOverlay.classList.remove('active');
                     setTimeout(() => {
                         elGoalContent.classList.remove('animate');
                         elGoalOs.innerText = "";
                     }, 500);
                 }, 4000);
             },

            triggerCardAnimation(eventId, cardEvent, team) {
                const elCardOverlay = document.getElementById(`card-overlay-${eventId}`);
                const elCardLogo = document.getElementById(`card-overlay-logo-${eventId}`);
                const elCardLabel = document.getElementById(`card-overlay-label-${eventId}`);
                const elCardPlayer = document.getElementById(`card-overlay-player-${eventId}`);
                const elCardPhoto = document.getElementById(`card-overlay-photo-${eventId}`);

                if (!elCardOverlay || !elCardLogo || !elCardLabel || !elCardPlayer || !elCardPhoto) return;

                const isRed = cardEvent.type === 'redcard';
                const playerName = cardEvent.athletesInvolved?.[0]?.displayName || 'Jogador';
                const playerPhoto = cardEvent.athletesInvolved?.[0]?.headshot?.href;
                const genericPhoto = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2EwYTBiMiI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMy41YzEuOTMgMCAzLjUgMS41NyAzLjUgMy41UzEzLjkzIDEyLjUgMTIgMTIuNXMtMy41LTEuNTctMy41LTMuNVMxMC4wNyA1LjUgMTIgNS41em0wIDEzLjVjLTIuOTcgMC02LjYxIDEuNDYtOC4wMyA0LjA0QzQuNDIgMjEuMjYgOC4wNiAyMiAxMiAyMnMyLjYxLS43NCAzLjk3LTEuNDZjLTEuNDItMi41OC01LjA2LTQuMDQtOC4wMy00LjA0eiIvPjwvc3ZnPg==';

                elCardOverlay.className = `unified-full-overlay ${isRed ? 'bg-red-overlay' : 'bg-yellow-overlay'}`;
                elCardLabel.innerText = isRed ? "Cartão Vermelho" : "Cartão Amarelo";
                elCardPlayer.innerText = playerName.toUpperCase();
                elCardLogo.src = team.team.logos?.[0]?.href || '';
                
                elCardPhoto.src = playerPhoto || genericPhoto;
                elCardPhoto.onerror = () => { elCardPhoto.src = genericPhoto; };

                // Use a timeout to ensure the class removal is processed before adding it again
                elCardOverlay.classList.remove('active');
                setTimeout(() => elCardOverlay.classList.add('active'), 50);

                // Hide overlay after animation
                setTimeout(() => elCardOverlay.classList.remove('active'), 4000);
            },

            triggerSubstitutionAnimation(eventId, subEvent, team) {
                const elSubOverlay = document.getElementById(`sub-overlay-${eventId}`);
                const elSubLogo = document.getElementById(`sub-overlay-logo-${eventId}`);
                const elPlayerOutName = document.getElementById(`sub-player-out-name-${eventId}`);
                const elPlayerInName = document.getElementById(`sub-player-in-name-${eventId}`);
                const elPlayerOutPhoto = document.getElementById(`sub-player-out-photo-${eventId}`);
                const elPlayerInPhoto = document.getElementById(`sub-player-in-photo-${eventId}`);

                if (!elSubOverlay || !elSubLogo || !elPlayerInName || !elPlayerOutName || !elPlayerInPhoto || !elPlayerOutPhoto) return;

                const playerOut = subEvent.athletesInvolved?.find(a => a.type === 'athleteout');
                const playerIn = subEvent.athletesInvolved?.find(a => a.type === 'athletein');

                if (!playerIn || !playerOut) return;
                
                const genericPhoto = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2EwYTBiMiI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMy41YzEuOTMgMCAzLjUgMS41NyAzLjUgMy41UzEzLjkzIDEyLjUgMTIgMTIuNXMtMy41LTEuNTctMy41LTMuNVMxMC4wNyA1LjUgMTIgNS41em0wIDEzLjVjLTIuOTcgMC02LjYxIDEuNDYtOC4wMyA0LjA0QzQuNDIgMjEuMjYgOC4wNiAyMiAxMiAyMnMyLjYxLS43NCAzLjk3LTEuNDZjLTEuNDItMi41OC01LjA2LTQuMDQtOC4wMy00LjA0eiIvPjwvc3ZnPg==';

                elSubOverlay.className = "unified-full-overlay bg-sub-overlay";
                elSubLogo.src = team.team.logos?.[0]?.href || '';
                
                elPlayerOutName.innerText = playerOut.displayName.toUpperCase();
                elPlayerInName.innerText = playerIn.displayName.toUpperCase();

                elPlayerOutPhoto.src = playerOut.headshot?.href || genericPhoto;
                elPlayerOutPhoto.onerror = () => { elPlayerOutPhoto.src = genericPhoto; };
                
                elPlayerInPhoto.src = playerIn.headshot?.href || genericPhoto;
                elPlayerInPhoto.onerror = () => { elPlayerInPhoto.src = genericPhoto; };

                elSubOverlay.classList.remove('active');
                setTimeout(() => elSubOverlay.classList.add('active'), 50);

                setTimeout(() => elSubOverlay.classList.remove('active'), 4500);
            },

            triggerVARAnimation(eventId, varEvent) {
                const elVarOverlay = document.getElementById(`var-overlay-${eventId}`);
                const elVarTitle = document.getElementById(`var-title-${eventId}`);
                const elVarSubtitle = document.getElementById(`var-subtitle-${eventId}`);

                if (!elVarOverlay || !elVarTitle || !elVarSubtitle) return;

                // --- Stage 1: Checking ---
                elVarOverlay.className = "unified-full-overlay bg-var-overlay";
                elVarTitle.innerText = "CHECANDO LANCE";
                elVarSubtitle.innerText = varEvent.text || "ÁRBITRO DE VÍDEO";

                elVarOverlay.classList.remove('active');
                setTimeout(() => elVarOverlay.classList.add('active'), 50);

                // --- Stage 2: Decision (Simulated or Parsed) ---
                const decisionTimeout = 5000;
                setTimeout(() => {
                    let decisionText = "LANCE CHECADO";
                    const eventTextLower = (varEvent.text || "").toLowerCase();

                    if (eventTextLower.includes('gol confirmado') || eventTextLower.includes('goal awarded')) {
                        decisionText = "DECISÃO: GOL CONFIRMADO";
                    } else if (eventTextLower.includes('gol anulado') || eventTextLower.includes('goal disallowed')) {
                        decisionText = "DECISÃO: GOL ANULADO";
                    } else if (eventTextLower.includes('pênalti marcado') || eventTextLower.includes('penalty awarded')) {
                        decisionText = "DECISÃO: PÊNALTI";
                    } else if (eventTextLower.includes('não foi pênalti') || eventTextLower.includes('no penalty')) {
                        decisionText = "DECISÃO: NÃO FOI PÊNALTI";
                    } else if (eventTextLower.includes('cartão vermelho') || eventTextLower.includes('red card')) {
                        decisionText = "DECISÃO: CARTÃO VERMELHO";
                    }

                    elVarTitle.innerText = decisionText;
                    elVarSubtitle.innerText = "REVISÃO CONCLUÍDA";

                    // --- Stage 3: Hide Overlay ---
                    const hideTimeout = 3000;
                    setTimeout(() => { elVarOverlay.classList.remove('active'); }, hideTimeout);
                }, decisionTimeout);
            },

            // CORREÇÃO: Adicionada a função que faltava para a animação de fim de jogo.
            triggerEndOfGameAnimation(eventId) {
                const elEogOverlay = document.getElementById(`eog-overlay-${eventId}`);
                if (!elEogOverlay) return;

                // Usa um timeout para garantir que a remoção da classe seja processada antes de adicioná-la novamente
                elEogOverlay.classList.remove('active');
                setTimeout(() => elEogOverlay.classList.add('active'), 50);

                // Esconde o overlay após a animação
                setTimeout(() => { elEogOverlay.classList.remove('active'); }, 5000);
            },

            startLiveCardTimer(eventId, competitionStatus) {
                const timeEl = document.getElementById(`timer-pill-${eventId}`);
                if (!timeEl || timeEl.dataset.timerActive) return null; // Não inicia se já estiver rodando
                timeEl.dataset.timerActive = 'true';

                const initialClock = competitionStatus.displayClock;
                const period = competitionStatus.period;
                const fetchTimestamp = Date.now();

                let baseMinutes = 0, addedMinutes = 0;
                if (initialClock.includes('+')) {
                    const parts = initialClock.replace("'", "").split('+');
                    baseMinutes = parseInt(parts[0]) || 0;
                    addedMinutes = parseInt(parts[1]) || 0;
                } else {
                    baseMinutes = parseInt(initialClock.replace("'", '')) || 0;
                }
                const initialTotalSeconds = (baseMinutes * 60) + (addedMinutes * 60);

                const timerId = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - fetchTimestamp) / 1000);
                    const currentTotalSeconds = initialTotalSeconds + elapsedSeconds;
                    const regularTimeEnd = period === 1 ? 45 : 90;
                    const regularTimeEndSeconds = regularTimeEnd * 60;

                    let timeString;
                    if (currentTotalSeconds < regularTimeEndSeconds) {
                        const displayMinutes = Math.floor(currentTotalSeconds / 60);
                        const displaySeconds = currentTotalSeconds % 60;
                        timeString = `${String(displayMinutes).padStart(2, '0')}:${String(displaySeconds).padStart(2, '0')} +00:00`;
                    } else {
                        const stoppageSeconds = currentTotalSeconds - regularTimeEndSeconds;
                        const stoppageMinutes = Math.floor(stoppageSeconds / 60);
                        const stoppageRemainingSeconds = stoppageSeconds % 60;
                    timeString = `${String(regularTimeEnd).padStart(2, '0')}:00 +${String(stoppageMinutes).padStart(2, '0')}:${String(stoppageRemainingSeconds).padStart(2, '0')}`; // Usar var(--font-family-primary)
                    }                    timeEl.innerHTML = `<span>${timeString}</span>`;
                }, 1000);

                return timerId;
            },

            startLiveMatchTimer(competitionStatus, details) {
                const timeEl = document.getElementById('modal-time');
                if (!timeEl) return;

                const initialClock = competitionStatus.displayClock;
                const period = competitionStatus.period;
                const fetchTimestamp = Date.now();

                let baseMinutes = 0, addedMinutes = 0;
                if (initialClock.includes('+')) {
                    const parts = initialClock.replace("'", "").split('+');
                    baseMinutes = parseInt(parts[0]) || 0;
                    addedMinutes = parseInt(parts[1]) || 0;
                } else {
                    baseMinutes = parseInt(initialClock.replace("'", "")) || 0;
                }
                let initialTotalSeconds = (baseMinutes * 60) + (addedMinutes * 60);

                let stoppageTime = 0;
                const stoppageEvent = details?.find(e => e.period === period && e.type === 'stoppagetime');
                if (stoppageEvent && stoppageEvent.clock?.displayValue) {
                    stoppageTime = parseInt(stoppageEvent.clock.displayValue.replace(/[+']/g, '')) || 0;
                }

                this.state.matchTimerInterval = setInterval(() => {
                    const currentTotalSeconds = initialTotalSeconds + Math.floor((Date.now() - fetchTimestamp) / 1000);
                    const regularTimeEnd = period === 1 ? 45 : 90;
                    const regularTimeEndSeconds = regularTimeEnd * 60;
                    let timeString;

                    if (currentTotalSeconds < regularTimeEndSeconds) {
                        const displayMinutes = Math.floor(currentTotalSeconds / 60);
                        const displaySeconds = currentTotalSeconds % 60;
                        timeString = `${String(displayMinutes).padStart(2, '0')}:${String(displaySeconds).padStart(2, '0')} +00:00`;
                    } else {
                        const stoppageSeconds = currentTotalSeconds - regularTimeEndSeconds;
                        const stoppageMinutes = Math.floor(stoppageSeconds / 60);
                        const stoppageRemainingSeconds = stoppageSeconds % 60;
                        
                        if (stoppageTime > 0 && stoppageMinutes >= stoppageTime) {
                            timeString = `${String(regularTimeEnd).padStart(2, '0')}:00 +${String(stoppageTime).padStart(2, '0')}:00`;
                        } else {
                            timeString = `${String(regularTimeEnd).padStart(2, '0')}:00 +${String(stoppageMinutes).padStart(2, '0')}:${String(stoppageRemainingSeconds).padStart(2, '0')}`;
                        } // Usar var(--font-family-primary)
                    }
                    timeEl.innerText = timeString;
                }, 1000);
            },

            closeModal() { 
                document.getElementById('match-modal').classList.remove('open'); 
                if (this.state.matchTimerInterval) {
                    clearInterval(this.state.matchTimerInterval);
                    this.state.matchTimerInterval = null;
                }
            },

            setTacticalFormation(teamType, formationName) {
                const formationButtons = document.querySelectorAll(`#tactical-controls-${teamType} .btn-formation`);
                formationButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.formation === formationName) {
                        btn.classList.add('active');
                    }
                });

                const coords = this.formations[formationName] || this.formations['default'];
                const players = document.querySelectorAll(`#pitch-${teamType} .player`);

                players.forEach((el, index) => {
                    if (coords[index]) {
                        el.style.top = coords[index].t + '%';
                        el.style.left = coords[index].l + '%';
                    }
                });
            },

            switchMatchModalTab(tabId) {
                const tabsContainer = document.getElementById('match-modal-tabs');
                if (!tabsContainer) return;

                const inactiveClass = 'px-6 py-4 text-sm font-bold border-b-2 transition whitespace-nowrap text-gray-400 border-transparent hover:text-white';
                const activeClass = 'px-6 py-4 text-sm font-bold border-b-2 transition whitespace-nowrap text-white border-[var(--accent)]';

                // Atualiza os estilos dos botões
                tabsContainer.querySelectorAll('button').forEach(btn => {
                    btn.className = (btn.dataset.tab === tabId) ? activeClass : inactiveClass;
                });

                // Atualiza a visibilidade dos painéis
                document.querySelectorAll('.match-tab-pane').forEach(pane => {
                    pane.classList.add('hidden');
                });
                const activePane = document.getElementById(`match-tab-${tabId}`);
                if (tabId === 'broadcast') {
                    this.fetchBroadcastForMatch();
                }

                if (activePane) {
                    activePane.classList.remove('hidden');
                }
            },

            toggleMobileLeague() { const m = document.getElementById('mob-league-menu'); if(m) { m.classList.toggle('hidden'); m.classList.toggle('flex'); } },
            
            updateActiveNav(viewId) {
                document.querySelectorAll('.nav-btn, .bottom-nav-item').forEach(b => b.classList.remove('active'));
                const deskBtn = document.getElementById(`desk-nav-${viewId}`); 
                if(deskBtn) deskBtn.classList.add('active');
                
                const mobBtn = document.getElementById(`mob-nav-${viewId}`); 
                if(mobBtn) mobBtn.classList.add('active');

                const activeNavBtn = document.querySelector('.nav-btn.active');
                if(activeNavBtn && activeNavBtn.querySelector('i')) {
                    document.querySelectorAll('.nav-btn i').forEach(i => i.style.color = 'inherit');
                    activeNavBtn.querySelector('i').style.color = 'var(--accent)';
                }
            },

            setView(v) {
                this.state.view = v; this.closeWiki();
                document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
                const viewEl = document.getElementById(`view-${v}`); if (viewEl) viewEl.classList.remove('hidden');
                this.updateActiveNav(v);
                this.loadDataForView();
            }
        };

        document.addEventListener('DOMContentLoaded', () => { if(window.lucide) window.lucide.createIcons(); app.init(); });
    </script>
</body>
</html> 